<!DOCTYPE html>
<script type="text/javascript" src="scripts/_basico.js"> </script>
<script type="text/javascript" src="scripts/_especializado.js"> </script>
<script type="text/javascript" src="watons_especializado.js"> </script>


<script>
  //nes wt += 4 'wt original'

  // bloquear caracteristicas de desarrollo al publicar betas
  var _MODO_DESARROLLO = 1;


  ini_root();

  //relativo a dispositivos moviles
  set_viewport({ width: 32*14+7, height: "", user_scalable: 0 });

  

  //|game
  var game =
  {
    objs: [],
    first_draw: 0,

    gestor:'',


    //|fadecon
    fadecon:
    {

      color:'rgba(255, 255, 255, 0.5)";',
      act:'',
      modos:
      {
        oscurecer:
        {
           tt:'',
           c:0,
           tt_pause:'',
           ini()
           {
           this.tt=[0,5];
           this.tt_pause=[0,4];
           this.c=0;
           },
           run() //retornar 1 = finalizado
           {
           
             this.tt[0]++;
             if(this.tt[0]>this.tt[1])
             {
               this.tt[0]=0;
               this.c+= (1.5 -this.c)/5;
               if(this.c>1)
               {
                this.c=1;
                this.tt_pause[0]++;
                if(this.tt_pause[0]>=this.tt_pause[1])
                return(1);
               }
               GES.canvasses[3].clear();
             GES.canvasses[3].fill('rgba(0, 0, 0, '+this.c+')'); 
                
             }

           
           }
           
        },
        
        aclarar:
        {
           tt:'',
           c:0,
           ini()
           {
           this.tt=[0,5];
           this.c=1;
           },
           run() //retornar 1 = finalizado
           {
           
             this.tt[0]++;
             if(this.tt[0]>this.tt[1])
             {
               this.tt[0]=0;
               this.c+= ((-0.5) -this.c)/5;
               if(this.c<0)
               {
                     GES.canvasses[3].clear();
                this.c=0;
                return(1);
               }
               GES.canvasses[3].clear();
             GES.canvasses[3].fill('rgba(0, 0, 0, '+this.c+')'); 
                
             }
             
           
           }
           
        },

      },
      run()
      {

        this.act.run();
      },
      set(f_modo, f_callback)
      {
        game.gestor.canvasses[3].no_clear=1;
        this.act = this.modos[f_modo];
        this.callback = f_callback;

        let _gestor   = game.gestor;
        let _canvasses = game.gestor.canvasses;
        //GES.tileges.estado = 0;
        //GES.fondoges.estado = 0;

        //  for (var u of _canvasses)
          //         u.no_clear = 0;

        //_canvasses[2].buffers[0].fill('red');
       this.act.ini();

       GES._enterframe=()=>{
        if(this.act.run())
        {
          //GES.canvasses[3].clear(); 
          GES._enterframe=()=>{}
           game.fadecon.callback();
             
        }
      }
 

      },

    },//fadecon

    soundcon:
    {
    estado:0,
      play(f_id)
      {
        if(this.estado)
        AUDIO.play_sample($WIN.LIB.SOUNDS[f_id],0);
      },

    },

    //|mapcon game
    mapcon:
    {
       map_master:'', //mapa original

       map:'',        //mapa    en curso
       submap:'',     //submapa en curso
       
      reset(_hard=0, _submap_id=0) 
      {
       if(_hard==0)
       game.mapcon.set_submap(_submap_id);
       
       else
       game.mapcon.set(this.map_master, _submap_id);

      },

       on_get_map()//empleado al guardar mapa; loguear
       {
       
       let _editor = game.editor.tile_editor;

       let _tilemap_obj = _editor.saveloop_objtile(_editor.tileges.tilemaps_all[3]);
           
        let _map = game.mapcon.map;
        let _copy = {};
           for(var i in _map)
           {
             if(i !=='submaps')
             _copy[i] = _map[i];

             else
             {
              let _submaps = [];
                for(var u of _map[i])
                {
                  let _submap = {};
                   for(var _i in u)
                   {
                    if(_i!=='tilemaps')
                    _submap[_i] = u[_i];
                    else
                    {
                    _submap[_i] = [u[_i][0],u[_i][1],u[_i][2],
                                  _editor.saveloop_objtile(u[_i][3])

                                 ];

                    }

                   }
                  _submaps.push(_submap);
                }
               _copy.submaps = _submaps;

             }

           }
            
             let _data = 
                  {
                   ...{
                       nombre: 'nuevo_mapa',
                       descripcion: "",
                      },

                    ..._copy
                  
                  }

          return(_data);
             

       },//on_get_map

       update_menu_submaps()
       {
         let _menu = game.editor.tile_editor.win.menu;
         _menu.Submaps['Submaps->'] = {};

        for(var i in this.map.submaps)
        {
         
          _menu.Submaps['Submaps->'][i]=(_menuclick)=>{
                                          
                                           game.mapcon.set_submap(_menuclick.nombre);

                                            };

        }

       },

       set_submap(f_id)
       {

         this.submap = this.map.submaps[f_id];
         game.editor.tile_editor.mapcon.set(this.submap); 

         for(var i of this.submap.tilemaps[3])
         {
          for(var j of i)
          {
            if(j!==0)
            {
              j.in=0;
            }
          }
         }

        game.first_draw=1;
        $root.hijos_clip = [];
        game.objs = [];

           
        var _level = WIN.gameges.crear_vacio($root, {w: fl(WIN._bloque.wr / 2), h: fl(WIN._bloque.hr / 2) });
        $root.level = _level;
        game.editor.tile_editor.offset_obj = _level;


        if(game.escenario.act.on_submapset)
        game.escenario.act.on_submapset();

       
       },
       set(_map=game.mapcon.map)
       {
        
        _map            = clone_object(_map);

        if(_map.submaps==undefined)
        {
          _map = {
                 ini_submap:0,
                 submaps: [_map]
                 };
        }
        for(var i in _map.submaps)
           _map.submaps[i].id = i;

        this.map = _map;
        this.map_master = clone_object(_map);



        this.update_menu_submaps();


        this.set_submap(this.map.ini_submap);





       }
 
    },//mapcon

    //|textoges
    textoges:
    {
     fuentes:
     {
      tn5x9:
            {
            img_id:20,
            w:[5,5],
            h:[9,9],
            },

      nb8x8:
            {
            img_id:16,
            w:[8,8],
            h:[8,8],
            },
      tn10x18:
            {
            img_id:19,
            w:[10,10],
            h:[18,18],
            },
      tn10x18_b: //press start
            {
            img_id:21,
            w:[10,10],
            h:[18,18],
            },
     },

    crear(f_donde=$root, f_data = {}, f_fuente='nb8x8')
    {
      let _fuente = this.fuentes[f_fuente];
      let _data ={
                  ...{
                     texto:'test',
                     x:0,
                     y:0,
                     gameges:WIN.gameges,
                     image:$LIB.IMAGES[_fuente.img_id],
                     canvas:DUMMY_CANVAS,
                  
                     ..._fuente
                     },
                     ...f_data
                 }

     return(RPG.crear_texto(f_donde, _data));

    },
    
    },


    //|particon
    particon:
    {
     data:'',
     _data_default:
        {
         map:
          {
           act:'',
           pos:[0,0],
          },

         //id_act:0,
         //act:'',//obj
           //|perfiles
           perfiles:
           {
            act:'',//obj
            id_act:'',//n

            set(f_id)
            {
             this.id_act = f_id;
             this.act = this.perfiles[f_id];

            },

            refill()
            {

             this.act.hp[0]=this.act.hp[1];
             this.act.pp[0]=this.act.pp[1];
            
            },
            set_var(f_n, f_var, _modo)
            {

                let _var = this.act[f_var];

                if(_modo=='set')
                _var[0]=f_n;
                if(_modo=='+')
                _var[0]+=f_n;
                if(_modo=='-')
                _var[0]-=f_n;

               if(_var[0]<0)
                 _var[0]=0;
               
               if(_var[0]>_var[1])
                  _var[0]=_var[1];

                if(game.escenario.act.hud.on_stats_update!==undefined)
                   game.escenario.act.hud.on_stats_update({value:_var, name:f_var, modo:_modo});

             

            },//set stats
            perfiles:
            [
                //maga
                {
                 name:'maga',
                 arma_name:'arco',
                 yvel_salto:4,
                 hp:[10,10],
                 pp:[10,10],
                 fama:0,
                 ataques:[],
                },
           
                //bartender
                {
                 name:'bartender',
                 arma_name:'espada',         
                 yvel_salto:3.3,
                 hp:[10,10],
                 pp:[10,10],
                 fama:0,
                 ataques:[],
                },                                
                
                //barba
                {
                 name:'barba',
                 arma_name:'arco',
                 yvel_salto:4,
                 hp:[10,10],
                 pp:[10,10],
                 fama:0,
                 ataques:[],
                },
           
                //mundano
                {
                 name:'mundano',
                 yvel_salto:4,
                 arma_name:'arco',
                 hp:[10,10],
                 pp:[10,10],
                 fama:0,
                 ataques:[],
                },
            ]

           }//stats

        },//particon

     _check_debug_partidanueva() //creacion de partida al acceder a escenas saltandose proceso habitual
     {
       if(this.data=='')
          this.nueva_partida(0);

     },
     nueva_partida(_goto_wmap=0)
     {
      this.data = clone_object(this._data_default);
      this.data.perfiles.set(1);//0-> 'maga'


      if(_goto_wmap)
      game.escenario.set('wmap')

     },


    },//particon

    //|dialogo
    dialogo:
    {
      dialogo: '',
      ini() {

        this.dialogo = RPG.crear_dialogo(WIN._bloque, {
          fuente: {
            img: $LIB.IMAGES[16],
          },
          teclado: WIN.teclado
        })

      },
      set() {
        this.dialogo.write.set(...arguments);

      },
      run() {
        if (this.dialogo !== '' && this.dialogo.write.estado !== 0)
          this.dialogo.run();

      },
      end() {
        if (this.dialogo !== '' && this.dialogo.write.estado !== 0) {
          this.dialogo.write.on_end();
        }

      },

    },

    //|escenario
    escenario:
    {
      act: '',
      set(_name) {

        //  game.first_draw =1;

        $root.hijos_clip = [];
        game.objs = [];

        game.dialogo.end();
        game.first_draw=1;

        GES.clear_all();
        GES._enterframe = () => { };
        GES.fondoges.fondos = [];
        GES.tileges.estado = 0;
        GES.fondoges.estado = 0;
        GES.tileges.remade_tilemaps(10, 10, 0);
        game.mapcon.map = { tilemaps: GES.tileges.tilemaps_all };
        GES.tileges.x = 0;
        GES.tileges.y = 0;


        for (var u of GES.canvasses)
          u.no_clear = 0;

        GES.tileges.refresh.force();


        delete $root.level;
        $root.x = 0;
        $root.y = 0;

        this.act = this.escenas[_name];

        if (this.act.editor?.img_id != undefined) {
          game.editor.iniset({ img_id: this.act.editor.img_id });
        }
        else {
          game.editor.cerrar();
        }


 

        if (this.act.editor?.tiledata_id != undefined) 
          {
            GES.tileges.tiledatas.set(this.act.editor.tiledata_id);
          }

        this.act.load();

        if (this.act.editor && $root.level)
          game.editor.tile_editor.offset_obj = $root.level;


      },
      enterframe() {

        WIN.set_title('Watons, legend of pipi [' + game.escenario.act.name + ']');

        if (this.act !== '') {
          this.act.enterframe();


               if($root?.level)
               {
                  $root.level.hijos_clip.sort(function(a,b){
                                       
                                         if(a._z==undefined)
                                           a._z=0;
                                         
                                         if(b._z==undefined)
                                           b._z=0;
                                         
                                          if(a._z<b._z)
                                            return(-1)
                                          
                                          if(a._z>b._z)
                                            return(1)
                                          
                                          return(0)
                    })
               }



          game.dialogo.run();

        }

      },

      //|escenas
      escenas:
      {
        //|intro
        intro_0: {
          name: 'intro_0',
          logo: '',
          tt: 0,
          _tt: [0, 15],
          load() {
            this.tt = 0;
            //var _level = WIN.gameges.crear_vacio($root,{w: fl(WIN._bloque.wr/2) ,h: fl(WIN._bloque.hr/2) });
            //$root.level = _level;    

            let _logo = this.logo = WIN.gameges.crear_imagen($root, 12, { x: 60, y: 55, w: 6 * 16, h: 1 * 16, cut_cords: { x: 0 * 16, y: 1 * 16, w: 6 * 16, h: 1 * 16 } });
            _logo.filter = { opacity: 100 }
            _logo.visible = false;

          },
          enterframe() {
            this.tt++;
            if (this.tt > 30) {
              this.logo.visible = true;
              if (this.tt > 60) {
                this._tt[0]++;
                if (this._tt[0] > this._tt[1]) {
                  this._tt[0] = 0;
                  this.logo.filter.opacity -= 20;
                  if (this.logo.filter.opacity < 0)
                  {
                    this.logo.filter.opacity = 0;
                    game.escenario.set('intro_1')
                  }

                }
              }
            }

          }
        },

        //|intro1
        intro_1: {
          name: 'intro_1',
          cinema: '',//clip
          c_id: 0,
          tt: [0, 10],
          estado: 0,
          set_cine(f_n) {

            let _cinema = this.cinema;
            _cinema.cut_cords = {
              x: 0,
              y: f_n * (5 * 16),
              w: 12 * 16,
              h: 5 * 16
            };
          },
          end_line()//llamado al terminar parrafo cinematico
          {
            this.estado = 1;
          },
          load() {
            this.c_id = 0;
            this.tt[0] = 0;
            this.estado = 0;

            let _cinema = this.cinema = WIN.gameges.crear_imagen($root, 15, {
              x: 16, y: 16,
              w: 12 * 16, h: 5 * 16,
              cut_cords: { x: 0 * 16, y: 0 * 16, w: 10 * 16, h: 5 * 16 }
            });
            _cinema.filter = { opacity: 0 };
            this.set_cine(this.c_id);

            GES.canvasses[2].no_clear = 1;

            let _script = '{"speed":[4,4], "pause":1000, "script":"game.escenario.act.end_line()" } {"next":"" }';
            let _s0 = '{"speed":[20,20]}';
            let _s1 = '{"speed":[5,5]}';

            game.dialogo.set(['{"id":"main","m_speed":[4,4]}Hace miles de años, en la Constelacion 73'+_s0+' ...' + _script ,
               'Existio lo que era llamado '+_s1+'el bar de los amiguitos.'+ _script,
               'Un magico lugar que acogia a las solitarias almas del multiverso.'+ _script,
               'Tiempos felices. Mas nadie hacia presagiar lo que el futuro les deparaba...'+'{"pause":9999999999999}',
              {
                asas: ['daasd']
              }
            ]

            );

            //draw_letra({canvas:GES.canvasses[2], char:'E', x:0,y:0, w:[8,8],h:[8,8], img:$LIB.IMAGES[16]})
          },
          enterframe() {
            let _cinema = this.cinema;

             //saltar
             if($TECLADO.get('enter',2)==1)
             {
             game.escenario.set('menu_0'); 
             }
             

            if (this.estado == 0) {
              this.tt[0]++;
              if (this.tt[0] > this.tt[1]) {
                this.tt[0] = 0;
                _cinema.filter.opacity += 15;
                  if (_cinema.filter.opacity >= 100)
                  {
                    _cinema.filter.opacity=100;
                    //this.estado = 1;
                  }
              }
            }
            if (this.estado == 1) {
              this.tt[0]++;
              if (this.tt[0] > this.tt[1]) {
                this.tt[0] = 0;
                _cinema.filter.opacity -= 15;
                if (_cinema.filter.opacity <= 0) {
                  _cinema.filter.opacity = 0;
                  this.estado = 0;
                  this.c_id++;
                  this.tt[0] = -30; //forma poco 'limpia' de retrasar aparicion
                  this.set_cine(this.c_id);
                }
              }
            }


          }
        },

        //|menu_0
        menu_0: {
          name: 'menu_0',
          editor: { img_id: [5,17], tiledata_id: 1 },
          textos:{},
          estado:0,
          estado_2:0,
          tt:[0,30,0],
          f_tt:[0,10],

          load() {//menu
            this.estado=0;
            this.estado_2=0;
            this.tt=[0,30,0];
            GES.tileges.estado = 1;
            GES.tileges.images[0] = $LIB.IMAGES[5];

            GES.fondoges.fondos = [];
            GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
            GES.fondoges.ini(1, { image: 10, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.ini(1, { image: 11, x: 0, y: 0 }); //canvasses gameges pintado

            GES.tileges.tilemaps[0][0][0]=1;
            let _map = $LIB.CLASES[11];
            
            GES.tileges.update_tilemaps(_map.tilemaps[0], _map.tilemaps[1], _map.tilemaps[2]);
            
            GES.fondoges.fondos[2].x=-30;
          //  var _level = WIN.gameges.crear_vacio($root,{w: fl(WIN._bloque.wr/2) ,h: fl(WIN._bloque.hr/2) });
            //    $root.level = _level;    

            let _logo = this.logo = WIN.gameges.crear_imagen($root, 12, 2,  
               {x: 8*4-5, y: 2, w: 10 * 16, h: 6 * 16, 
               cut_cords: { x: 0 * 16, y: 2 * 16, w: 10 * 16, h: 6 * 16 } });

           
           this.textos.presstart = game.textoges.crear($root, {x:50,y:90, texto:'PRESS START'},'tn10x18_b')
           

          },
          enterframe() {
            //this.textos.presstart.y++;
            
            this.f_tt[0]++;
            if(this.f_tt[0]>this.f_tt[1])
            {
              this.f_tt[0]=0;
              GES.fondoges.fondos[1].x--;
            }
            
            if(this.estado==1)
            {
                 let _empezar = this.textos.empezar;
                 let _opciones= this.textos.opciones;
                 
                 if($TECLADO.get('izq'))
                  this.estado_2=0;
                if($TECLADO.get('der'))
                  this.estado_2=1;


                    if(this.estado_2==0)
                    {
                     _empezar.y  = _empezar.ini_y-5;
                     _opciones.y = _opciones.ini_y;
                    if($TECLADO.get('z',2)==1)
                      {
                        this.estado=3;

                         game.fadecon.set('oscurecer',   ()=>{
                       
                         game.particon.nueva_partida(1);

                         game.fadecon.set('aclarar',   ()=>{});

                       } );
                      
                      //game.particon.nueva_partida(1);
                      

                      }
                    }
                    if(this.estado_2==1)
                    {
                     _empezar.y  = _empezar.ini_y;
                     _opciones.y = _opciones.ini_y-5;
                      
                    }

            }

            if(this.estado==0)
            {
              
               if($TECLADO.get('z',2)==1)
               {
                //this.textos.presstart.set_text('aa');
               this.textos.presstart.visible=false;
               this.estado=1;

       
               this.textos.empezar = game.textoges.crear($root,  {x:20,y:100,   texto:'Empezar'})
               this.textos.opciones = game.textoges.crear($root, {x:120,y:100,  texto:'Opciones'})
               this.textos.empezar.ini_x = this.textos.empezar.x;
               this.textos.empezar.ini_y = this.textos.empezar.y;

               this.textos.opciones.ini_x = this.textos.opciones.x;
               this.textos.opciones.ini_y = this.textos.opciones.y;
               
               }
              this.tt[0]++;
              if(this.tt[0]>this.tt[1])
              {
                
                this.tt[0]=0;
                if(this.tt[2]==0)
                {
                 this.textos.presstart.y+=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==1)
                {
                 this.textos.presstart.y+=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==2)
                {
                 this.textos.presstart.y-=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==3)
                {
                 this.textos.presstart.y-=2;
                 this.tt[2]=0;
                }

              }
              
            }

          }
        },


        //|wmap
        wmap:
        {
          name: 'wmap',
          editor: { img_id: [13,17],   tiledata_id: 0 },
          
          on_nuevapartida()
          {
          let _mapcon = this.mapcon;
          },
          on_mapoint_openselect(f_obj)
          {
           this.hudbottom.on_mapoint_openselect();
          },
          on_mapoint_start(f_obj)
          {
   
             game.fadecon.set('oscurecer',   ()=>{ 

                 let _script = cargar_txt("_data/maps/"+f_obj.mapa, (_map)=>{     

                             
                             game.escenario.escenas.play_0.map = _map;

                             game.escenario.set('play_0');



                              game.fadecon.set('aclarar',   ()=>{ })

                                                      }  , 1);
          

                })


            

           // this.hudbottom.on_mapoint_start();


           console.log('mapoint start')
          },
          on_mapoint_stand(f_obj)
          {
           this.hud.update_level_titulo(f_obj.mapa);
           console.log('mapoint stand')
          },
          on_mapoint_leave(f_obj)
          {
            //this.hud.update_level_titulo('');
             console.log('mapoint leave')
          },

          mapcon:
          {
            savepos: { x: 1, y: 3 },//en tile

            _ids:
            {
            test:9,
            anonimo:0
            },

            get(f_name)
            {
            let _id = this._ids[f_name];
            return($LIB.CLASES[_id]);
            },
            set(f_name)
            {
            let _map = this.get(f_name);
            game.escenario.set('wmap')
            },

          },//mapcon

          hud:
          {
            _padre: '',
            hud: '',
            textos:{},
            
            update_level_titulo(f_texto)
            {
            this.textos.level_titulo.set_text(f_texto);
            },

            ini() {
              let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: fl(WIN._bloque.wr / 2),
                  h: 16*2,
                  y: 0,
                  draw_color: 'black'
                });

              this.textos.level_titulo = game.textoges.crear(_hud, {x:0,y:0, texto:' '})
              this.update_level_titulo('')

            },

          },
          //|hudbottom wmap
          hudbottom:
          {
            hud:'',
            estado:0,
            y_open: 16*9,
            on_mapoint_openselect()
            {
             this.estado=1;
            },
            
            selector:
            {
              _padre:'',
              caras:[],
              id:'',
              selector:'', //obj
              set(f_id)
              {
               this.id=f_id;

               this.selector.x = this.caras[this.id].x;
               
               game.particon.data.perfiles.set(this.id);
               //game.particon.data.id_act = this.id;

              },
              ini()
              {
                let _hud = this._padre.hud;
                
                //crear imagenes watons
                for(var i =0;i<4;i++)
                {
                this.caras.push( WIN.gameges.crear_imagen(_hud, 12, 2, { x: i*32 + (16*(i+1) ), y: 8, w: 32,h:32,
                                         cut_cords:{x:i*32,y:8*16, w:32, h:32  }  })
                                );
                }

                this.selector = WIN.gameges.crear_imagen(_hud, 12, 2, { x: (0)*32 + (16*((0)+1) ), y: 8, w: 32,h:32,
                                                         cut_cords:{x:4*32,y:8*16, w:32, h:32  }  });
              
                
                this.set(game.particon.data.perfiles.id_act);


              },
                run() //lamado solo si hudbottom.estado==1
                {

                  if(this._padre.estado==2)
                  {
                    

                    if(WIN.teclado.get('izq',2)==1 && this.id>0)
                    this.set(this.id-1);
                 
                    if(WIN.teclado.get('der',2)==1 && this.id<3)
                    this.set(this.id+1);

                    if(WIN.teclado.get('z',2)==1)
                    {
                    $root.level.jugador.estado=6;
                    this._padre.estado=3;  
                    }

                 } 
                 


                },

            },//selector

            ini()
            {
               this.estado=0;
                let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: fl(WIN._bloque.wr / 2),
                  h: 16*4,
                  x: 0,
                  y: 17*11,
                  draw_color: 'black'
                });
              
                this.selector._padre = this;
                this.selector.ini();
                

            },
            run()
            {
              this.selector.run();

               if(this.estado==1)
               {
                this.hud.y += (this.y_open-this.hud.y)/10;
                if(this.hud.y<=this.y_open+1)
                {
                  this.hud.y=this.y_open;
                  this.estado = 2;  
                }
               }
            }
           

          },

          load() {//wmap
            game.particon._check_debug_partidanueva();
            this.hud._padre = this;

            GES.tileges.images[0] = $LIB.IMAGES[13];
            GES.tileges.estado = 1;

            GES.fondoges.fondos = [];
            GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
            GES.fondoges.ini(1, { image: 10, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.ini(1, { image: 11, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.estado = 1;

            let _map = clone_object($LIB.CLASES[9]);

            
            game.mapcon.set(_map,0);


          },

          on_submapset()
          {
          let _savepos = this.mapcon.savepos;
          WIN.gameges.cargar_clase($root.level, 8, { x: _savepos.x * 16, y: _savepos.y * 16, nombre: 'jugador' }); //jugador
           
          this.hud.ini();
          this.hudbottom.ini();
          },

          enterframe() {
            
            this.mapcon.savepos.x = fl($root.level.jugador.x / 16);//provisorio
            this.mapcon.savepos.y = fl($root.level.jugador.y / 16);//provisorio
            this.hudbottom.run();
            //GES.canvasses[2].no_clear=1;
            //GES._enterframe=()=>{GES.canvasses[2].draw.line(0,0,100,100);}

          }


        },//map



        //|play
        play_0:
        {
          name: 'play_0',
          editor: { img_id: [5,17], tiledata_id: 1 },

          map:'',
                          //{value, name, modo}
          
          hud:
          {
            _padre: '',
            
            hudbarras:{  },
            textos:{},

            ini() {
              let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: fl(WIN._bloque.wr / 2),
                  h: 16,
                  y: 11 * 16,
                  draw_color: 'black'
                });
               let _stats = game.particon.data.perfiles.act;

               this.hudbarras.hp = game.crear_hudbarra(_hud, 
                     {valores:_stats.hp, x:1, y:6, w:8*5, h:6, texto:{x:-1,y:-7,texto:'salud'}, colores:['gray','white'  ]  })
               
               this.hudbarras.pp = game.crear_hudbarra(_hud, 
                    {valores:_stats.pp, x:(8*5)+5, y:6, w:8*5, h:6, texto:{x:-1,y:-7,texto:'magia'}, colores:['gray','white'  ]  })

              
            },

          on_stats_update(f_obj)
          {
           this._padre.hud.hudbarras[f_obj.name].set(f_obj.value[0], 'set');
           if(f_obj.name=='hp'&&f_obj.value[0]<=0)
           {
             game.mapcon.reset();
             game.particon.data.perfiles.refill();
             //game.escenario.set('wmap');
             this.update_hudbarras();
           }

          },

          update_hudbarras()
          {
            let _stats = game.particon.data.perfiles.act;
            for(var i in this.hudbarras)
            {
              this.hudbarras[i].set(_stats[i][1], 'set');
            }

          },

          },//hud
           load()  //play
           {
            this.hud._padre = this;

            game.particon._check_debug_partidanueva();
            if(this.map == '') //por precaucion
            this.map = $LIB.CLASES[7];  
            
            GES.tileges.estado = 1;
            GES.tileges.images[0] = $LIB.IMAGES[5];

            GES.fondoges.fondos = [];
            GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 10, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 11, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.estado = 1;
            
            game.mapcon.set(this.map, 0);

          },

          on_submapset()
          {
          WIN.gameges.cargar_clase($root.level, 0, { x: 2 * 16, y: 4 * 16, nombre: 'jugador' }); //jugador
          this.hud.ini();

          },

          enterframe() {
          
                        




            //GES.canvasses[2].no_clear=1;
            //GES._enterframe=()=>{GES.canvasses[2].draw.line(0,0,100,100);}
          },

         

        },//play_0

      },//escenas

    },//escenario

    //|ini
    ini() {

      WIN.teclado.add_keydown(bindear_(game.on_keydown, game));
      WIN.cursor.add_mousedown(bindear_(game.on_mousedown, game));
      WIN.cursor.add_mouseup(bindear_(game.on_mouseup, game));
      WIN.cursor.add_mousemove(bindear_(game.on_mousemove, game));

      var ARR_CAN = [crear_canvas(this._bloque, 2, 0, 0, this._bloque.wr, this._bloque.hr),
      crear_canvas(this._bloque, 2, 0, 0, this._bloque.wr, this._bloque.hr),
      crear_canvas(this._bloque, 2, 0, 0, this._bloque.wr, this._bloque.hr),
      crear_canvas(this._bloque, 2, 0, 0, this._bloque.wr, this._bloque.hr),
      ];

      window['GES'] = GAME.crear_gestor(WIN, ARR_CAN,
        {
          donde: WIN._bloque,
          w: ARR_CAN[0].wr / 2,
          h: ARR_CAN[0].hr / 2
        });
      game.gestor = GES;

      GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
      GES.fondoges.estado = 0;

      GES.tileges.ini_with_buffers([1, 1, 2],
        //ini data
        {
          id: 5,
          wt: 16, ht: 16,
          yt_max: 12, xt_max: 12+3
        }
      );
      GES.tileges.estado = 0;
      
      GES.tileges.tiledatas.tiledatas=[];
      GES.tileges.tiledatas.add($LIB.CLASES[10], 0);//worldmap
      GES.tileges.tiledatas.add($LIB.CLASES[6], 1);//main game


      GES.tileges.on_draw_stroke = function (_modo) {
        if (_modo == 'all')
          game.first_draw = 0;
      }

      GES.tileges.on_draw_tile = function (_y, _x, _modo) {
        
        if (_modo == 'x' || _modo == 'y' || (_modo == 'all' && game.first_draw == 1)) {

          let _maps = GES.tileges.tilemaps_all;
          if (_maps[3][_y] &&
              _maps[3][_y][_x] !== 0 && _maps[3][_y][_x] !== undefined && _maps[3][_y][_x].in == 0) {
            let u = _maps[3][_y][_x];
            u.x = _x;
            u.y = _y;
            
                       game.cargar_enemigo(
                       {
                       x: _x,
                       y: _y,
                       mapdata: u,
                       }
                       );
            console.log('objeto ' + u.id + ' creado')


          }
        }
      }


      $root.w = fl(WIN._bloque.wr / 2);
      $root.h = fl(WIN._bloque.hr / 2);

      game.dialogo.ini();

      crear_enterframe(_root, WIN, function () 
      {
        //workaround
       _root.set_$(WIN);
      

       game.escenario.enterframe(); 
      });

      game.escenario.set('play_0');


    },//ini

    //|editor
    editor:
    {
      estado: -1, //0 = modo juego; 1 = modo editor; -1 = desactivado
      tile_editor: '',
      on_keydown(_k) {
    
         if(this.estado>=0)
         {
            if (_k.key == 'Escape' && _MODO_DESARROLLO) 
            {
            game.first_draw=1;
            this.set(swap_bin(this.estado),1 );
            }
         }

      },
      on_mousedown(e) {
        if(this.estado==1) 
        {
        let _xm = (e.offsetX / 2) - $root.level.x;
        let _ym = (e.offsetY / 2) - $root.level.y;
          for (var u of game.objs) {
            if (game.simple_hit_test(u, { x: _xm, y: _ym, w: 1, h: 1 })) {
              

              this.tile_editor.estado_tiledraw = 0;
              this.tile_editor.objcon.set(fl(_xm/16), fl(_ym/16));

              this.grab.obj = u;
              this.grab.plus[0] = u.x - _xm;
              this.grab.plus[1] = u.y - _ym;

              //actualizar capa obj
             let _obj = this.grab.obj;
             let _mapdata = _obj.mapdata;

             game.mapcon.submap.tilemaps[3][_mapdata.y][_mapdata.x] = 0;
             

             }
          }
        }

      },

      on_mousemove(e) {
        if (this.estado==1 && this.grab.obj !== '') {
          let _obj = this.grab.obj;
          if(e.offsetX<0) e.offsetX=0;
          if(e.offsetY<0) e.offsetY=0;
          

          let _xt = fl(((e.offsetX / 2) - $root.level.x + this.grab.plus[0] + _obj.w / 2) / 16);
          let _yt = fl(((e.offsetY / 2) - $root.level.y + this.grab.plus[1] + _obj.h / 2) / 16);
          
          

          _obj.x = _xt * 16;
          _obj.y = _yt * 16;

        }

      },
      on_mouseup(e) {
        if(this.estado==1 && this.grab.obj!== '')
        {
          this.tile_editor.estado_tiledraw=1;

          let _obj = this.grab.obj;
          let _mapdata = _obj.mapdata;
          let _xt = fl(((e.offsetX / 2) - $root.level.x + this.grab.plus[0] + _obj.w / 2) / 16);
          let _yt = fl(((e.offsetY / 2) - $root.level.y + this.grab.plus[1] + _obj.h / 2) / 16);
              if(_xt<0) _xt=0;
              if(_yt<0) _yt=0;
          
          //si esta ocupado el espacio por otro objeto
          if(game.mapcon.submap.tilemaps[3][_yt][_xt]!==0)
          {
            game.mapcon.submap.tilemaps[3][_yt][_xt]._clip.remove();
          }

          _mapdata.x = _xt;
          _mapdata.y = _yt;
          //game.map.maps[0][_yt][_xt]=1;     //test
          game.mapcon.submap.tilemaps[3][_yt][_xt] = _mapdata;

          this.grab.clear();

        }        
      },
 
        set(f_n = this.estado, f_mapupdate=0)//cambio estado
        {
          console.log("set editor: "+f_n);
          this.estado = f_n;
          this.tile_editor.estado = f_n;

          this.tile_editor.set_capa_act(); //forzar actualizacion titulo ventanaeditor
          if (this.estado == 1) { //activar
            this.grab.clear();
            WIN.macrobloque.header.titulo.obj.style.background = 'gray';
            let _jugador = $root.level.jugador;
            let _psave = { x: _jugador.x, y: _jugador.y };


            if(f_mapupdate)
            {
            game.mapcon.map.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map_master.submaps[game.mapcon.submap.id]);
            game.mapcon.reset(0, game.mapcon.submap.id);
            }

            $root.level.jugador.x = _psave.x;
            $root.level.jugador.y = _psave.y;
          }
          else { //editor to 9
            
            if(f_mapupdate)
            {

            game.mapcon.map_master.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map.submaps[game.mapcon.submap.id]);
            //game.mapcon.map_master.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map.submaps[game.mapcon.submap.id]);
            }

            this.grab.clear();
            WIN.macrobloque.header.titulo.obj.style.background = 'lightgray';
          }
        },


      grab: {
        obj: '',
        plus: [0, 0],
        clear() {
          this.obj = '';
          this.plus = [0, 0];
        }

      },
     
      cerrar() { //llamado al cambiar a una escena sin editor
        if(this.tile_editor !== '') {
          this.set(0);

          this.tile_editor.win.cerrar();
          this.tile_editor = '';
          this.estado=-1;
        }

      },          //{image_url:'' }
      iniset(f_data = {}) //llamado escenario->set
      {
        if (this.tile_editor !== '') 
        {
          console.log('editor imagen cambiada')

          this.tile_editor.images=[$LIB.IMAGES[f_data.img_id[0]], $LIB.IMAGES[f_data.img_id[1]]];            
          this.tile_editor.set_modo()
          this.tile_editor.estado_tiledraw=1;
        }
        else {
          console.log('editor creado')
          console.log(f_data.img_id + "<------------")
          this.tile_editor = DEBUG.crear_tile_editor(
            _root,
            {
              ...{
                x: WIN.x + WIN.wr, y: WIN.y,
                odiv_des: WIN._bloque,
                cursor_des: WIN.cursor_bloque,

                tileges: $tileges,                
                
                on_get_map: game.mapcon.on_get_map,
                

                mapcon:
                {
                 on_load(_map)
                 {
                  game.mapcon.set(_map,0);
                 },

                },

        
                menu:{ //se incorporan a funciones por defecto
                 Map:
                  {
                    'Nuevo mapa'(){
                       let _tileges = this.tileges;
                       _tileges.remade_tilemaps(_tileges.yt_max,_tileges.xt_max,0);

                        game.remove_all_obj();
                        $root.level.jugador.x=0;
                        $root.level.jugador.y=0;
                     
                    },
                   'Limpar mapa'(){
                    let _tilemaps_all =this.tileges.tilemaps_all;

                      for(var k of _tilemaps_all)
                      {
                        for(var i in k)
                        {
                          for(var j in k[i])
                          {
                              k[i][j]=0;
                          }
                        }
                      }
                     this.tileges.refresh.force();
                      game.remove_all_obj();
                      


                   },
                   

                  },//map
                  Submaps:
                  {
                   'Log submaps'()
                   {
                    console.log(game.mapcon.map.submaps)

                   },
                   'Submaps->':
                   {
                      

                   }
                 }//submaps
                },

                objcon:{
                        callback: bindear_(game.cargar_enemigo, game)
                       },


                images: [$LIB.IMAGES[f_data.img_id[0]], $LIB.IMAGES[f_data.img_id[1]]], 
                
                offset_obj: { x: 0, y: 0 },

                tw: 4,
                th: 4,
                minimap_scale: 4,
                key:
                {
                  erase: ['lshift', 0], //tecla, indice tile vacio
                  drop: 'ctrl',
                },
                on_set_title(f_text) {
                  return (f_text + '[' + game.editor.estado + ']');
                },
                on_save_objtile(f_obj) {

                  if (f_obj !== 0 && f_obj !== undefined) {
                    let _end = clone_object(f_obj);
                    _end.in = 0;
                    delete _end._clip; //eliminar referencia clip
                    return (_end);
                  }
                  return (f_obj);

                }

              },
              ...f_data
            })//creacion editor
        }
        this.set(0);

        WIN.obj.focus();


      },

    },//editor
    on_keydown(_key) {
        this.editor.on_keydown(_key);
    },
    on_mousedown(e) {
        this.editor.on_mousedown(e);
    },
    on_mouseup(e) {
        this.editor.on_mouseup(e);
    },
    on_mousemove(e) {
        this.editor.on_mousemove(e);
    },


    center_compare(_a, _b) {
      let _end = { x: '', y: '' };

      if (_a.x + _a.w / 2 < _b.x + _b.w / 2)
        _end.x = 0;
      else
        _end.x = 1;

      if (_a.y + _a.h / 2 < _b.y + _b.h / 2)
        _end.y = 0;
      else
        _end.y = 1;

      return (_end);

    },
    simple_hit_test(_a, _b) {

      if (_a.x + _a.w > _b.x && _a.x < _b.x + _b.w &&
        _a.y + _a.h > _b.y && _a.y < _b.y + _b.h) {
        return (1);
      }

    },


  center_nivel(f_x, f_y)
  {

    $root.level.x = fl((f_x * -1)  + $root.w / 2);
    $root.level.y = fl((f_y * -1)  + $root.h / 2);

    if ($root.level.x > 0) 
      $root.level.x = 0;
    
    if ((-$root.level.x) + $gameges.tileges.xt_max * 16 > $gameges.tileges.xt_allmax * 16) 
      $root.level.x = -($gameges.tileges.xt_allmax * 16 - $gameges.tileges.xt_max * 16);
    
    if ($root.level.y > 0) 
      $root.level.y = 0;
    
    if ((-$root.level.y) + $gameges.tileges.yt_max * 16 > $gameges.tileges.yt_allmax * 16) 
      $root.level.y = -($gameges.tileges.yt_allmax * 16 - $gameges.tileges.yt_max * 16);
    
    $gameges.tileges.x = $root.level.x * -1;
    $gameges.tileges.y = $root.level.y * -1;

  },


    

    remove_all_obj() {
      for(var i = this.objs.length-1; i>=0;i--)
        this.objs[i].remove();

      this.objs = [];


    },
    remove_obj(obj) {
      for (var i = 0; i < this.objs.length; i++) {
        let u = this.objs[i];
        if (u == obj) {
          this.objs.splice(i, 1);
          break;
        }

      }
    },
    cargar_enemigo(f_data) {
      let _x = f_data.x;
      let _y = f_data.y;

      console.log("!!!!!!!")
      console.log(f_data)
      let _clip = WIN.gameges.cargar_clase($root.level, 5,
        {
          
          ...f_data.mapdata,
          ...{
             y: _y * 16,
             x: _x * 16,
             id: f_data.mapdata.id,
             //draw_color:'blue'
             },
        }
      );
      _clip.noclone = 1;

      $tileges.tilemaps_all[3][_y][_x]._clip = _clip;

      _clip.mapdata = f_data.mapdata;
      this.objs.push(_clip);
      _clip.mapdata.in = 1;

      if(this.editor.first_draw==0)//workaround problema level x inadecuado borra enemigos
      enterload(_clip);


    },

    crear_hudbarra(f_donde, f_data={})
    {
       let _data = {
                    ...{
                       x:0,
                       y:0,
                       w:100, //max
                       h:10,
                       texto:{x:0,y:0,texto:''}, //reemplzadado con clip_text posteriormente
                       
                       colores:['white','red'], // fondo, frontal
                       valores:[50,200],
                       clips:[],
                       remove()
                       {
                        for(var u of this.clips)
                        {
                          u.remove();
                        }
                       },
                       
                       set(f_n, _modo)
                       {
                          if(_modo=='set')
                          this.valores[0]=f_n;
                          if(_modo=='+')
                          this.valores[0]+=f_n;
                          if(_modo=='-')
                          this.valores[0]-=f_n;

                        if(this.valores[0]<0)
                          this.valores[0]=0;
                        if(this.valores[0]>this.valores[1])
                          this.valores[0]=this.valores[1];

                        let _w = this.valores[0]/this.valores[1]; //0->1
                          
                    
                         this.clips[1].w = fl(this.w*_w);

                       },
                       },
                    ...f_data
                   }

   _data.clips =
   [
   WIN.gameges.crear_vacio(f_donde, 2,
                {
                  w: _data.w,
                  h: _data.h,
                  y: _data.y,
                  x: _data.x,
                  draw_color: _data.colores[0],
                }),
   WIN.gameges.crear_vacio(f_donde, 2,
                {
                  w: _data.w,
                  h: _data.h,
                  y: _data.y,
                  x: _data.x,
                  draw_color: _data.colores[1],
                })
    ];

    _data.texto = game.textoges.crear(f_donde, {x:_data.x+_data.texto.x, y:_data.y+_data.texto.y, texto:_data.texto.texto})

    _data.clips.push(_data.texto);

    
    _data.set();            



    return (_data);


    }

  }//game



//padrear(_game);





  var WIN = ventana.crear_ventana(_root,
    //400   400
    {
      x: 0, y: 0, w: 32*14, h: 32*12, teclado: 1, titulo: "", grab: 1, resize: 0,literal:1,
      menu: {
        Juego: {
          'Reiniciar->':
          {

          'Hard mapa'() 
          {
            

          },
          'Soft submapa'() {
            game.mapcon.reset(0, game.mapcon.sub);

          },


          }
          
        },
        Opciones: { Controles: 'Proximamente' },
        Escenas: {
          'intro_0'() { game.escenario.set('intro_0') },
          'intro_1'() { game.escenario.set('intro_1') },
          'menu_0'() { game.escenario.set('menu_0') },
          'wmap'() { game.escenario.set('wmap') },
          'play_0'() { game.escenario.set('play_0') },

        },
        $Ayuda: {
          'Acerca de...'() {
            alert('23/09/2023')




          }
        }

      }
    },
    {
      borde: [5, 5, 5, 5],
    })


  WIN._bloque.obj.style.background = "black";



  if (IS_MOBILE) {
    WIN.set_h(WIN.hr + 100);
    TECLADO.crear_teclado_visual(WIN, WIN.teclado, 'basico');
  }





  WIN.load_isc(["_data/images/fondo_0.png",
    "_data/images/image_03.png",
    "_data/images/lau_spritesheet.png",
    "_data/images/efecto16.png",
    "_data/images/tileset16_0.png",
    "_data/images/lau_tileset16_0.png",//5

    "_data/images/shoot.png",
    "_data/images/enemigos_sprites.png",
    "_data/images/armas_sprites.png",
    "_data/images/fondo_A0.png",
    "_data/images/fondo_A1.png", //10
    "_data/images/fondo_A2.png",
    "_data/images/misc.png",
    "_data/images/lau_tileset16_wm.png",
    "_data/images/watons_sprites_wm.png",

    "_data/images/cinema.png",//15
    "_data/images/fuente_nb8x8.png",
    "_data/images/tileobj_1.png",
     "_data/images/tileobj_0.png",
     "_data/images/fuente_tn10x18.png",
     "_data/images/fuente_tn5x9.png",//20
     "_data/images/fuente_tn10x18_b.png", //press start menu
     "_data/images/npc.png"

  ],

    [
    /*"_data/sounds/hit_0.wav",
    "_data/sounds/hit_1.wav",

    "_data/sounds/jump_0.wav",
    "_data/sounds/jump_1.wav",
    "_data/sounds/jump_2.wav",
    */
     ],

    ["_data/class/player.js",
      "_data/class/obj_e16.js",
      "_data/class/obj_testvacio.js",
      "_data/class/obj_test_entesprite.js",
      "_data/class/shoot.js",
      "_data/class/enemigos.js",//5

      "_data/class/config.json",
      "_data/maps/00.json",
      "_data/class/player_wm.js",
      "_data/maps/wm00.json",
      "_data/class/tiledata_wm.json",//10

      "_data/maps/menu0.json",

    ],


    game.ini);



</script>