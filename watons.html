<!DOCTYPE html>
<script type="text/javascript" src="scripts/_basico.js"> </script>
<script type="text/javascript" src="scripts/_especializado.js"> </script>
<script type="text/javascript" src="watons_especializado.js"> </script>


<script>






  //nes wt += 4 'wt original'

  // bloquear caracteristicas de desarrollo al publicar betas
  var _MODO_DESARROLLO = 1;


  ini_root();


  //relativo a dispositivos moviles
  set_viewport({ width: 32*14+7, height: "", user_scalable: 0 });


  //constantes dialogos
  //var $C_NAME = `{"script":" ( game.particon.data.perfiles.act.name.toUpperCase().charAt(0)+game.particon.data.perfiles.act.name.slice(1)) "}`;

  $CNAME = function(){ 
  
  return(game.particon.data.perfiles.act.name.toUpperCase().charAt(0)+game.particon.data.perfiles.act.name.slice(1) )


   }
  

  //|game
  var game =
  {
    objs: [],
    first_draw: 0,

    gestor:'',

    wcanvas:'',
    hcanvas:'',

    set_var(f_n, f_var, _modo)//atajo propiedades perfil
    {
    game.particon.data.perfiles.set_var(f_n, f_var, _modo);
    },

    //|misc
    misc:
    {
      crear_rebotinero(f_data)//f_x, f_y, f_id=4, on_touch=function(){ })
      {

        if(f_data.modo=='hp')
        {
          f_data.id=7;
          f_data.w=5;
          f_data.h=5;
          f_data.on_touch= function(){
                           game.particulas_con.flyer_hp(1,this.x, this.y)
                           game.soundcon.play(17,1);
                           this.remove();
                           }
          }
          if(f_data.modo=='pp')
        {
          f_data.id=8;
          f_data.w=5;
          f_data.h=5;
          f_data.on_touch= function(){
                           game.particulas_con.flyer_pp(1,this.x, this.y)
                           game.soundcon.play(17,1);
                           this.remove();
                           }
          }
          if(f_data.modo=='exp')
        {
          f_data.id=4;
          f_data.w=5;
          f_data.h=5;
          f_data.on_touch= function(){
                           game.particulas_con.flyer_exp(1,this.x, this.y)
                           game.soundcon.play(17,1);
                           this.remove();
                           }
          }

              let _data =
                        {
                        ...{
                          x:0,
                          y:0,
                          w:16,
                          h:16,
                          gravity:0.1,
                          id:4,
                          can_col:1,
                          tt:[0,210,    0, 10, 8],
                          on_touch:function(){},
                          _load:function(){ 
                            this.xvelocity= Math.random()*5-2.5;
                            this.yvelocity=-Math.random()*3; },
                          _enterframe:function(){},
                        },
                        ...f_data
                        }

                  let _clip = $WIN.gameges.cargar_clase($root.level, 1, {
                            x: _data.x,
                            y: _data.y,
                            anim_id:_data.id,
                            __w:_data.w,
                            __h:_data.h,
                            gravity:_data.gravity,
                            can_col:_data.can_col,
                            on_touch:_data.on_touch,
                            xvelocity: 0,
                            yvelocity: 0,
                            tt:_data.tt,
                           // draw_color:'blue',
                            _load:_data._load,
                   enterframe(){
                    if(game.simple_hit_test(this, $root.level.jugador))
                    {

                      this.on_touch();
                    }
                    this.w=this.__w;
                    this.h=this.__w;
                    //this._w=this.__w;
                    //this._h=this.__h;

                    this.yvelocity+=this.gravity;

                    this.x = this.x + this.xvelocity;
                    this.y = this.y + this.yvelocity;
                    if(this.can_col)
                    {
                    let _col = col_check(this,0);
                    if(_col[1])
                    {
                      this.yvelocity =-this.yvelocity/1.4;
                      this.xvelocity = this.xvelocity/1.1;
                    }
                    if(_col[3])
                    {
                      this.yvelocity=0.5;
                    }
                    if(_col[0]||_col[2])
                    {
                      this.xvelocity = -this.xvelocity/2;
                    }
                    }
                    this.xprev=this.x;
                    this.yprev=this.y;

                    if(this.tt!=='')
                    {
                      this.tt[0]++;
                      if(this.tt[0]>this.tt[1])
                      {
                        this.tt[2]++;
                        if(this.tt[2]>this.tt[3])
                        {
                          if(this.visible==true) this.visible=false;
                          else this.visible=true;
                          
                          this.tt[2]=0;
                          this.tt[4]--;
                          if(this.tt[4]==0)
                            this.remove();
                        }
                      }
                    }

                 } });
                  _clip._load();
                  
                
             return (_clip);

      },


    },

    //|particulas_con
    particulas_con:
    {
      
      caja_destrozada(_x, _y)
      {

        let _xp = Math.random();

          game.misc.crear_rebotinero(
                                     {
                                     x:_x,
                                     y:_y,
                                     w:16,
                                     h:16,
                                     can_col:0,
                                     gravity:0.1,
                                     id:5, 
                                     _load(){
                                      this.yvelocity=-2;
                                      this.xvelocity=-1-_xp;
                                     }
                                   });
          game.misc.crear_rebotinero(
                                     {
                                     x:_x,
                                     y:_y,
                                     w:16,
                                     h:16,
                                     can_col:0,
                                     gravity:0.1,
                                     id:6, 
                                     _load(){
                                      this.yvelocity=-2;
                                      this.xvelocity= 1+_xp;
                                     }
                                   });
                
      },

      flyer_exp(_n, _x, _y)
      {
      game.particulas_con.flyer(_x, _y, 3, (game.hcanvas-10)-3, 4, function(){this.remove(); game.set_var(_n,'exp', '+')   } );
      },

      flyer_hp(_n, _x, _y)
      {
      game.particulas_con.flyer(_x, _y, 3, (game.hcanvas-10)+2, 7, function(){this.remove(); game.set_var(_n,'hp', '+')   } );
      },
      flyer_pp(_n, _x, _y)
      {
      game.particulas_con.flyer(_x, _y, 3, (game.hcanvas-10)+7, 8, function(){this.remove(); game.set_var(_n,'pp', '+')   } );
      },
      

      flyer(_x, _y, _xd=0, _yd=(game.hcanvas-10), _id=4, on_end=function(){this.remove()  })
      {
         

        let _clip = $WIN.gameges.cargar_clase($root, 1, 
        {LOAD:{canvas_id:2}, x: _x+$root.level.x, y: _y+$root.level.y,anim_id:_id, 
           xd:_xd, yd:_yd,
        enterframe(){
        this.x += (this.xd-this.x)/10;
        this.y += (this.yd-this.y)/10;
        if(this.x>this.xd-1&&this.x<this.xd+1 &&
           this.y>this.yd-1&&this.y<this.yd+1)
          {
          this.on_end();
          }
        
       } });

        _clip.on_end = on_end;

       return(_clip);

      },


    },

    //|efectocon
    efectocon:
    {
      efectos:[],
      _efectos:
      {
        v_move:
          {
            tt:[0,5],
               ini()
               {
                

               },
               run()
               {
                let _jugador = $root.level.jugador;
               
                    _jugador = $root.level.jugador;
                    _jugador.camera_offset.yp=3; 

                this.tt[0]++;
                if(this.tt[0]==this.tt[1])
                {
                 _jugador.camera_offset.yp=0;
                 return (1);                  
                }
                

               },

          },
          

      },

       add(f_name)
       {
         let _clone = clone_object(this._efectos[f_name]);
         this.efectos.push( _clone );
         _clone.ini();

       },

       run()
       {
        for(var i = this.efectos.length-1; i>=0;i--)
        {
          let u = this.efectos[i];

           let _a = u.run();
           if(_a==1)
           {
              this.efectos.splice(i,1);
           }

        }

       }

    },

    //|fadecon
    fadecon:
    {

      color:'rgba(255, 255, 255, 0.5)";',
      act:'',
      modos:
      {


        oscurecer:
        {
           tt:'',
           c:0,
           tt_pause:'',
           ini()
           {
           this.tt=[0,5];
           this.tt_pause=[0,4];
           this.c=0;
           },
           run() //retornar 1 = finalizado
           {
           
             this.tt[0]++;
             if(this.tt[0]>this.tt[1])
             {
               this.tt[0]=0;
               this.c+= (1.5 -this.c)/5;
               if(this.c>1)
               {
                this.c=1;
                this.tt_pause[0]++;
                if(this.tt_pause[0]>=this.tt_pause[1])
                return(1);
               }
               GES.canvasses[3].clear();
             GES.canvasses[3].fill('rgba(0, 0, 0, '+this.c+')'); 
                
             }

           
           }
           
        },
        
        aclarar:
        {
           tt:'',
           c:0,
           ini()
           {
           this.tt=[0,5];
           this.c=1;
           GES.canvasses[3].clear();
           GES.canvasses[3].fill('rgba(0, 0, 0, '+this.c+')'); 

           },
           run() //retornar 1 = finalizado
           {
           
             this.tt[0]++;
             if(this.tt[0]>this.tt[1])
             {
               this.tt[0]=0;
               this.c+= ((-0.5) -this.c)/5;
               if(this.c<0)
               {
                     GES.canvasses[3].clear();
                this.c=0;
                return(1);
               }
               GES.canvasses[3].clear();
               GES.canvasses[3].fill('rgba(0, 0, 0, '+this.c+')'); 
                
             }
             
           
           }
           
        },

      },
      run()
      {

        this.act.run();
      },
      set(f_modo, f_callback)
      {
        game.gestor.canvasses[3].no_clear=1;
        this.act = this.modos[f_modo];
        this.callback = f_callback;

        let _gestor   = game.gestor;
        let _canvasses = game.gestor.canvasses;
        //GES.tileges.estado = 0;
        //GES.fondoges.estado = 0;

        //  for (var u of _canvasses)
          //         u.no_clear = 0;

        //_canvasses[2].buffers[0].fill('red');
       this.act.ini();

       GES._enterframe=()=>{
        if(this.act.run())
        {
          //GES.canvasses[3].clear(); 
          GES._enterframe=()=>{}
           game.fadecon.callback();
             
        }
      }
 

      },

    },//fadecon

    //|fondocon
    fondocon:
    {
       
      fondos:
       {
        campo_a:
              {
                tt: [0, 25, 0],
                ini()
                {
                  GES.fondoges.ini(0, { image: 9, x: 0, y: 0 }); 
                  GES.fondoges.ini(0, { image: 10, x: 0, y: 0 });
                  GES.fondoges.ini(0, { image: 11, x: 0, y: 0 });
                },
                run(_level_x, _level_y)
                {

                //GES.canvasses[3].buffers[0].clear();

                this.tt[0]++;
                if (this.tt[0] > this.tt[1]) 
                {
                  this.tt[0] = 0;
                  this.tt[2] += 1;
                }
                $gameges.fondoges.fondos[0].x = (_level_x / 7);
                //$gameges.fondoges.fondos[0].y = ($root.level.y) - 10;
                $gameges.fondoges.fondos[1].x = (_level_x / 3) - this.tt[2];
                //$gameges.fondoges.fondos[1].y = ($root.level.y) - 25;
                $gameges.fondoges.fondos[2].x = (_level_x / 3);
                //$gameges.fondoges.fondos[2].y = ($root.level.y) - 25;

                }
              },

              campo_b:
              {
                
                ini()
                {
                  GES.fondoges.ini(0, { image: 26, x: 0, y: 0 }); 
                  GES.fondoges.ini(0, { image: 27, x: 0, y: 0 });
                },
                run(_level_x, _level_y)
                {
                
                $gameges.fondoges.fondos[0].x = (_level_x / 7);
                $gameges.fondoges.fondos[1].x = (_level_x / 3);

                //$gameges.fondoges.fondos[0].y = ($root.level.y) - 10;
                
                //$gameges.fondoges.fondos[1].y = ($root.level.y) - 25;
               // $gameges.fondoges.fondos[2].x = ($root.level.x / 3);
                //$gameges.fondoges.fondos[2].y = ($root.level.y) - 25;

                }
              }
       
       },

       clear()
       {
         this.act="";
       },

       

       set(f_fondo)
       {

            GES.fondoges.fondos = [];
            game.mapcon.slidecon.f_scroll.x=0;
            game.mapcon.slidecon.f_scroll.y=0;

            this.act="";
            if(this.fondos[f_fondo.id]!==undefined)
            {
            let _act = clone_object(this.fondos[f_fondo.id]);
            this.act = _act;
            _act.ini();
            }
            GES.fondoges.estado = 1;

       },
       run()
       {
            if(this.act!=='')
            {
             let _x = $root.level.x;
              
             _x += game.mapcon.slidecon.f_scroll.x;

              this.act.run(
                _x,
                $root.level.y
                );
            }
       },


    },//fondocon

   //|itemcon
  itemcon:
  {
    estado:0,
    points:[],
    items_macro:
    {
      "Inventario vacio":
       {
         name:'',
         id:100,
         descripcion:'Invetario vacio',
         remove_on_use:0,
         no_usable:1,
         usar()
         {
           game.itemcon.close();
         },

       },//invetario vacio


     "Bom y Bom":
       {
         name:'',
         id:0,
         remove_on_use:1,
         descripcion:'Un bombon de chocolate que aumenta 5HP',
         no_usable:0,
         usar()
         {
           game.set_var(5, 'hp', '+');

           game.itemcon.close();


         },

       },//bom y bom
       "Nota de las acciones":
       {
         name:'',
         id:1,
         descripcion:'En este popular libro encontraras tus poderes actuales',
         no_usable:0,
         usar()
         {

           //$root.contenedor.draw_color='gray';
           for(var u of _clip.itemcon.items)
            u.clip.visible=false;

          
              let _book = (WIN.gameges.crear_vacio($root.contenedor, 2,
                 {
                   w: game.wcanvas-16,
                   h: game.hcanvas-16-16,
                   x: 8,
                   y: 8,
                   draw_color: 'rgba(0,0,0,0.4)',
                   nombre:'page'
              }));

              _clip.itemcon.textos.inventario.visible=false;

              game.textoges.crear(_book, {x:60, y:10, _onload(){}, texto:"Ataques de Mundano:"},'tr8x8');
              game.textoges.crear(_book, {x:10, y:20, texto:"Recuperacion"},'tr8x8');
              


          
            //_clip.itemcon.textos.inventario._onload =()=>{}

           //game.fadecon.set('oscurecer',   ()=>{});

         },

       },//nota de las acciones
       "Chocboy":
       {
         name:'',
         id:2,
         descripcion:'Este bizcocho de chocolate aumenta 10PP',
         remove_on_use:1,
         no_usable:0,
         usar()
         {
           game.set_var(10, 'pp', '+');

           game.itemcon.close();
         },

       },//chocboy
       
       "Papa George":
       {
         name:'',
         id:3,
         descripcion:'Aumenta 20HP',
         usar()
         {
         },

       },//Papa George

      
    },//items_macro

    add_item(f_nombre)
    {
        let _item = {...clone_object(this.items_macro[f_nombre]),
                    ...{
                       name:f_nombre,
                       p:0,
                       }
                    };

        this.items.push(_item);

        this.save_en_particon();
    },
    items:[
           
           ],
    act_id:0,
    tt:[0,5,0],
    move_dir:1,
    move_tt:[0,10],
    textos:{},
    
    save_en_particon()
    {
      game.particon.data.items = [];
      for(var u of this.items)
      {
        game.particon.data.items.push(u.name);
      }
    },

    on_particon_set(f_items=game.particon.data.items)
    {
      this.items = [];
      this.act_id=0;
      for(var u of f_items)
      {
        this.add_item(u);  
      }
    },
    close()
    {
     if(this.items.length==1&&this.items[0].name=='Inventario vacio')
     {
      this.items=[];
     }
      


      for(var u of $root.level.hijos_clip)
      {
        u.enabled_enterload = 1;
        if(u.animdata)
           u.animdata.pause=0;

       for(var o of u.hijos_clip)
         {
           //o.enabled_enterload = 0;
              if(o.animdata)
                 o.animdata.pause=0;
         }

      }

     this.estado=0;
     this.move_dir=1;
     this.points=[];
     this.textos.nombre.remove();
     this.contenedor.remove();

     for(var u of this.items)
     {
      u.clip.remove();
     }

    },
    on_empty_open()
    {
       this.add_item('Inventario vacio');
       this.act_id=0;
    },

    open()
    {
      if(this.items.length==0)
      this.on_empty_open();

      //_root.propagar_enterframe = this.estado;
      for(var u of $root.level.hijos_clip)
      {

        u.enabled_enterload = 0;
        if(u.animdata)
           u.animdata.pause=1;

         for(var o of u.hijos_clip)
         {
           //o.enabled_enterload = 0;
              if(o.animdata)
                 o.animdata.pause=1;
         }
      }
      //$root.level.enabled_enterload = 0;
      



      this.move_tt[0]=0;
      this.estado=1;
      
      this.contenedor = (WIN.gameges.crear_vacio($root, 2,
                 {
                   w: game.wcanvas,
                   h: game.hcanvas-16,
                   x: 0,
                   y: 0,
                   draw_color: 'rgba(0,0,0,0.4)',
                   nombre:'contenedor'
                }));
      if(game.escenario.act.name=='wmap')this.contenedor.y+=16;

      this.textos.inventario = game.textoges.crear($root.contenedor, {x:60, y:10, texto:"Inventario"},'tnb10x18');
      this.textos.inventario.visible=false;

      this.textos.nombre= game.textoges.crear($root.contenedor, {x:game.wcanvas/2, y:game.hcanvas/2, texto:"Chocboy"},'tnb10x18');
      this.textos.nombre.visible=false;

      
      this.foo = function(x,y, _c='blue', w=2,h=2)
      {
      
           return (WIN.gameges.crear_vacio($root, 2,
                 {
                   w: w,
                   h: h,
                   x: x,
                   y: y,
                   draw_color: _c,
                }));

      }


         //array 0->1
         let _v = [[1,0,-1, 0,   1],
                   [0,1, 0,-1,   0]];
         let n = 0.1;
         let _end = [[],[]];
          for(var i =0;i<4;i++)
          {
             let  a = _v[0][i];
             let _a = _v[0][i+1];

             let  b = _v[1][i];
             let _b = _v[1][i+1];

             while(a!=="infinito")
             {
             if(a<_a){a+=n;if(a>=_a){a=_a; break;} }
             if(a>_a){a-=n;if(a<=_a){a=_a; break;} }
               _end[0].push(a);
             }
             while(b!=="infinito")
             {
             if(b<_b){b+=n;if(b>=_b){b=_b; break;} }
             if(b>_b){b-=n;if(b<=_b){b=_b; break;} }
             _end[1].push(b);
             }
             
          }  

          let x = 120;
          let y = 55;
          for(var i=0;i<_end[0].length;i++)
          {
             x += _end[0][i]*20;
             y += _end[1][i]*2;
             let _p = this.foo(x,y,'');
                 _p.id=this.points.length;
             this.points.push(_p);
          }
         

         for(var i =0;i<this.items.length;i++)
         {
          let _d = (this.points.length/this.items.length);

          let _i =  _d*i;

          let _p = this.points[rd(_i) ];


          let _id = this.items[i].id;
           let _clip =
            WIN.gameges.crear_sprite($root.contenedor, 29, 2, 
              {animdata: GAME.crear_animdata(     
             
           { master: { wt: 32, ht: 32, ll: 30 } },
           { ll: 15, flip: [0, 0], offset: [0, 0], buf: [[_id, 0],[_id, 1],[_id, 2],[_id, 3],[_id, 4],[_id, 5],[_id, 6],[_id, 7]]  },
           { ll: 20, flip: [0, 0], offset: [0, 0], loop:1, buf: [[_id, 8],[_id, 9],[_id, 10],[_id, 11] ]  },
          
             
                )  });
            _clip.animdata.set_anim(0);

            this.items[i].items_i = i;
            this.items[i].clip=_clip;
            this.items[i].point = _p;
            this.items[i].i = rd(_i) ;
         } 
         
         this.act = this.foo(0,0,'black');


        while(this.items[this.act_id].point.id!==30)
        {
        this.rotate(-1);
        }


  
    },

    rotate(_dir)
    {
     for(var u of this.items)
     {
        let _i = u.i;
        if(_dir==-1)
        {
          _i =u.i+1;
            if(_i>this.points.length-1)
            _i=0;
         }
        if(_dir==1)
        {
          _i =u.i-1;
            if(_i<0)
            _i=this.points.length-1;
         }
         

         let p = this.points[_i];
         u.clip.x= p.x;
         u.clip.y= p.y;
         u.point = p;
         //u.clip.h= 26-((((game.hcanvas)/2)-p.y)/3);
         u.clip._h= fl(35-((((game.hcanvas+40)/2)-p.y)/5));
         u.clip._w= u.clip._h;
         u.clip.y-= fl(u.clip._h/2);
         u.clip.x-= fl(u.clip._w/2);
         u.clip.animdata.pause=1;
         u.clip.animdata.act[1]=0;

         u.i = _i;
     }

       $root.contenedor.hijos_clip.sort(function(a,b){
                                       
                                         if(a.y==undefined)
                                           a.y=0;
                                         
                                         if(b.y==undefined)
                                           b.y=0;
                                         
                                          if(a.y<b.y)
                                            return(-1)
                                          
                                          if(a.y>b.y)
                                            return(1)
                                          
                                          return(0)
                    })
                    

    },

    move_item(_n)
    {
      game.soundcon.play(15,1);
      this.move_dir=_n;
      this.act_id+= _n;
      if(this.act_id<0)
        this.act_id=this.items.length-1;

      else if(this.act_id>this.items.length-1)
               this.act_id=0;

    },

    run()
    {
     let _clip = $root.level.jugador;

      if($WIN.teclado.get('k',2)==1)
      {
        this.add_item('Chocboy');
      }

     if($WIN.teclado.get('c',2)==1 && this.estado!==3)//3=usando objeto
     {   if(this.estado==0)
         {
         this.open();
         }           

         else
         {
         this.close();
         }          

      }
      let _item;
       let _iclip;
      if(this.estado>0)
      {
       _item = this.items[this.act_id];
       _iclip = _item.clip;
      }


     if(this.estado==1)
     {
      
         //item principal centrado
         if(this.items[this.act_id].point.id==18)
         {

          this.items[this.act_id].clip.animdata.pause=0;

          if(this.move_tt[0]==0)
          {

            this.textos.nombre.set_text(this.items[this.act_id].name)
            this.textos.nombre._onload=()=>
                          {
                         this.textos.nombre.visible=true;
                         this.textos.nombre.x= game.wcanvas/2-this.textos.nombre.w/2;
                          }
          }
          this.move_tt[0]++;
         if(this.move_tt[0]>=this.move_tt[1] && this.items.length>1)
         { 
           if($WIN.teclado.get('izq'))
           {
             this.move_tt[0]=0;
             this.move_item(1);
           }
           if($WIN.teclado.get('der'))
           {
             this.move_tt[0]=0;
             this.move_item(-1);
           }
         }

           if($WIN.teclado.get('z',2)==1&&this.items[this.act_id].no_usable!==1)
           {
             this.estado=2;
             this.estado_2=0;
             this.estado_3=0;

             this.textos.usar  = game.textoges.crear($root.contenedor, {x:game.wcanvas/2-70, y:game.hcanvas/2+16, texto:"Usar"},"tnb10x18");
             this.textos.info  = game.textoges.crear($root.contenedor, {x:game.wcanvas/2-18, y:game.hcanvas/2+16, texto:"Info"},"tng10x18");
             this.textos.tirar = game.textoges.crear($root.contenedor, {x:game.wcanvas/2+40, y:game.hcanvas/2+16, texto:"Tirar"},"tng10x18");

             //this.textos.usar.set_font($LIB.IMAGES[31]);


           }

        }

        //si item central no esta centrado
        if(this.items[this.act_id].point.id!==18)
        {
        this.rotate(this.move_dir); 
        }
      if($WIN.teclado.get('x',0)==1)//workaround evitar efectuar ataque
      {
       game.itemcon.close();
      }
    }//estado ==1


     if(this.estado==3)//item usado 
     {
      if(_iclip.animdata.act[0]==0)
      {
      _iclip.animdata.animations[_iclip.animdata.act[0]].ll=1;
      if(_iclip.animdata.act[1]<_iclip.animdata.animations[_iclip.animdata.act[0]].buf.length/2)
      _iclip.animdata.force.reverse=1;
      if(_iclip.animdata.act[1]==0)
        _iclip.animdata.pause=1;
      }
      
      if(_iclip.animdata.pause==1 || _iclip.animdata.act[0]==1)
      {
        this.usar_tt++;
        if(this.usar_tt==30)
        {
          _iclip.animdata.force.reverse=0;
          _iclip.animdata.pause=0;

         _iclip.animdata.set_anim(1);
        }
        if(this.usar_tt==30+ ( (_iclip.animdata.animations[1].buf.length-1+1.5)*_iclip.animdata.animations[1].ll) )
        {

          _item.usar();
          if(_item.remove_on_use)
          { 
           this.items.splice(_item.items_i,1);
           this.save_en_particon();
          }
          this.act_id--;
          if(this.act_id<0)
            this.act_id=this.items.length-1;

          return;



        }
        //if(_iclip.animdata.act[0]==1 && _iclip.animdata.act[1]==_iclip.animdata.animations[1].buf.length-1 && _iclip.)
        
          
        
      }
      //_iclip.y--; 


     }

    //item enfocado
    if(this.estado==2)
    {
      let _foo = [this.textos.usar,this.textos.info, this.textos.tirar];
       
      
      
      _iclip.y+= (50-_iclip.y)/10;
      _iclip._w+= (40-_iclip._w)/10;
      _iclip._h= _iclip._w;
      _iclip.x = _item.point.x-_iclip._w/2;


     if($WIN.teclado.get('z',2)==1)
     {

      if(this.estado_2==0) //|usar
       {
         this.estado=3;
         this.usar_tt=0;
         this.textos.nombre.visible=false;
         this.textos.usar.visible=false;
         this.textos.info.visible=false;
         this.textos.tirar.visible=false;
          
          //_item.usar();

       }

       if(this.estado_2==1) //info
       {
        if(this.estado_3==0)
        {
         this.textos.usar.visible=false;
         this.textos.info.visible=false;
         this.textos.tirar.visible=false;
         this.estado_3=1;
         this.textos.descripcion = game.textoges.crear($root.contenedor, {_onload(){
        //this.draw_color='blue';
         this.x = (game.wcanvas/2)-this.w/2;

         }, x:60, y:this.textos.usar.y, max_char:20, texto:_item.descripcion},'tnb10x18');
        }
        else if(this.estado_3==1)
        {
         this.estado_3=0;
         this.textos.descripcion.remove();
         this.textos.usar.visible=true;
         this.textos.info.visible=true;
         this.textos.tirar.visible=true;
        }

       }

     }

   if(this.estado_3==0)
    {

      if($WIN.teclado.get('izq',2)==1)
        {
          if(this.estado_2>0)
          {
            game.soundcon.play(11);  
          _foo[this.estado_2].set_font($LIB.IMAGES[31]);
           this.estado_2--;
           _foo[this.estado_2].set_font($LIB.IMAGES[30]);
         }
        }
       else if($WIN.teclado.get('der',2)==1)
        {
          if(this.estado_2<2)
          {
            game.soundcon.play(11);  
          _foo[this.estado_2].set_font($LIB.IMAGES[31]);
             this.estado_2++;
           _foo[this.estado_2].set_font($LIB.IMAGES[30]);
          }
         }      
      }


       if($WIN.teclado.get('x',2)==1)
       {
        
        if(this.estado_3==0)
        {
        this.estado=1;
        this.rotate(0);
        this.textos.usar.remove();
        this.textos.info.remove();
        this.textos.tirar.remove();
        }
        else if(this.estado_3==1)
        {
         this.estado_3=0;
         this.textos.descripcion.remove();
         this.textos.usar.visible=true;
         this.textos.info.visible=true;
         this.textos.tirar.visible=true;
        }


       }
    }

   }
    
  },//itemcon


   //|soundcon
    soundcon:
    {

    estado:1,
      
      //|temacon 
      temacon:
      {
        _padre:'',
        act:'',
        stop()
        {
         if(this.act!=='')
         {
         this.act.stop();
         this.act='';
         }

        },

         get_vol()
         {
          if(this.act!=='')
            {
            return(this.act.gain.gain.value);
            }

         },
         set_vol(_vol = 1)
         {
            if(this.act!=='')
            {
            this.act.gain.gain.value= _vol;
            }

         },
         play(f_id, f_gain=1, f_pitch=0, f_loop=0, f_time=0, f_offset=undefined)
        {
           
         if(this.act==='' || this.act.id!==f_id)
         {

         this.stop();
         
         this.act = AUDIO.play_sample(WIN.LIB.SOUNDS[f_id], f_gain*game.particon.data.config.sound.vol_music, f_pitch, f_loop,   f_time, f_offset);
         
         this.act.id=f_id;
         }
         else if(this.act.id === f_id)
         {
          
          this.act.gain.gain.value= game.mapcon.submap.tema.vol*game.particon.data.config.sound.vol_music; //test desmarcar
         }

        },

        ini_leveltema() //llamado en mapcon -> set_submap
        {

          let _submap = game.mapcon.submap;
          let _tema = _submap.tema;
          
          if(game.editor.estado==1)
          {
            this.stop();
            return;
          }

          this.play(_tema.id,_tema.vol,0,1);       
        }

      },//temacon

      tile_play(f_id, f_gain)
      {
        let _td = $gameges.tileges.tiledata.col[f_id];
        let _sid = 19;
        if(get_type(_td[4])=='number' )
          _sid = _td[4];

        this.play(_sid, f_gain);

      },

      play(f_id, f_gain=1, f_pitch=0, f_loop=0)
      {
        if(f_pitch=='random')
        {
          f_pitch=1-Math.random();
        }

        if(this.estado)
        AUDIO.play_sample(WIN.LIB.SOUNDS[f_id], f_gain*game.particon.data.config.sound.vol_sound, f_pitch, f_loop);

      },

    },

    //|mapcon game
    mapcon:
    {
      _padre:'',
       map_master:'', //mapa original

       map:'',        //mapa    en curso
       submap:'',     //submapa en curso
       

       run()
       {
         this.slidecon.run();

       },

      //|slidecon
      slidecon:
      {
      _padre:'',
      estado:0,

      
      lim:0,
      f_scroll:{x:0,y:0},
      p_save:{x:0,y:0, xvelocity:0,yvelocity:0},
      tileobj:'',
      maps_wht:[{w:0,h:0},{w:0,h:0}], //prev, new
      clear()
      {
       this.estado=0;
      },

        alien:{x:0,y:0, estado:0, objtile: ''},

                   //2,3,4,5 esperados
        start_alien(f_estado, f_objtile)
        {

           let _level = $root.level;
           let _jugador = $root.level.jugador;

           this.estado=1;

           this.alien.estado = f_estado;
           this.alien.objtile = f_objtile;

           let _wt = [$gameges.tileges.xt_max, $gameges.tileges.xt_allmax];
           let _ht = [$gameges.tileges.yt_max-1, $gameges.tileges.yt_allmax];


           game.remove_all_obj();
           game.mapcon.slidecon.player_saveprops();
         
           _jugador.modos.set('freeze');


           //calcular posiciones
           if(f_estado==2 || f_estado == 4)
           {
             if(f_objtile.alien[0]=="A")
             this.alien.y=0;
             
             if(f_objtile.alien[0]=="B")
             this.alien.y=( (_ht[1]-_ht[0])*16 )*-1;

           if(f_estado==2)
             this.alien.x=0;

           if(f_estado==4)
             this.alien.x= (_wt[1]*16-_wt[0]*16)*-1 ;
           
           }


           if(f_estado==3 || f_estado == 5)
           {
             if(f_objtile.alien[0]=="A")
             this.alien.x=0;
             
             if(f_objtile.alien[0]=="B")
             this.alien.x=( (_wt[1]-_wt[0])*16 )*-1;

           if(f_estado==3)
             this.alien.y=0;

           if(f_estado==5)
           {
             this.alien.y= (_ht[1]*16-_ht[0]*16)*-1 ;
           }
           
           }
  

        },

          end_estado:0,
         start_end(f_estado, f_tile) //terminar nivel al tocar borde de la pantalla
         {
           if(this.end_estado==0)
           {
            this.end_estado=f_estado;
             let _jugador = $root.level.jugador;
             let _yvel = _jugador.yvelocity;
            _jugador.modos.set('freeze');
           
            _jugador.yvelocity = _yvel;
             let _col = _jugador.col_check();
             _jugador.modos.modos.freeze.run = ()=>
             {
               _jugador.yvelocity += _jugador.gravedad;
               let _col = _jugador.col_check();

             }

             game.fadecon.set('oscurecer',   ()=>{
                         
                         game.escenario.set('wmap');
                         game.escenario.escenas.wmap.set_clearpath(f_tile.clear);

                         game.fadecon.set('aclarar',   ()=>{
                          this.end_estado=0;

                         });

                  })
           }

         

         },

        start_slide(f_dir)
        {
           let _level = $root.level;
           let _jugador = $root.level.jugador;

           this.estado=f_dir;
        //   game.remove_all_obj();         
        //   _jugador.modos.set('freeze')

           let _wt = [$gameges.tileges.xt_max, $gameges.tileges.xt_allmax];
           let _ht = [$gameges.tileges.yt_max-1, $gameges.tileges.yt_allmax];

           let _level_yt = fl( (_level.y*-1)/16 );
           let _level_xt = fl( (_level.x*-1)/16 );
           this.level_yt = _level_yt;
           this.level_xt = _level_xt;

    //     this.player_saveprops();
           this.p_save.x = (_jugador.x- (this.level_xt*16) ) ;
           this.p_save.y = (_jugador.y- (this.level_yt*16) ) ;


           let _map  = game.mapcon.map;
           let _smap = clone_object(game.mapcon.submap);
           let _nmap = clone_object(game.mapcon.map.submaps[this.alien.objtile.id_submap]);

           this.maps_wh = [{ 
                            w:_smap.tilemaps[0][0].length*16,
                            h:_smap.tilemaps[0].length*16,
                            wt:_smap.tilemaps[0][0].length,
                            wt:_smap.tilemaps[0][0].length,
                            },
                            {
                            w:_nmap.tilemaps[0][0].length*16,
                            h:_nmap.tilemaps[0].length*16,
                            wt:_nmap.tilemaps[0][0].length,
                            ht:_nmap.tilemaps[0].length,
                            }
                            ];

           if(f_dir==2)
           {
               this.f_scroll.x+=this.maps_wh[1].w;

               for(var k = 0;k<3;k++)
               {
                
                  for(var i = 0; i<  _ht[0]; i++)
                  {
                  if(this.alien.objtile.alien[1]=="A")
                    _smap.tilemaps[k][_level_yt + i] = [..._nmap.tilemaps[k][i], ..._smap.tilemaps[k][_level_yt + i] ];  

                  if(this.alien.objtile.alien[1]=="B")
                    _smap.tilemaps[k][_level_yt + i] = [..._nmap.tilemaps[k][_nmap.tilemaps[0].length-_ht[0]+i],  ..._smap.tilemaps[k][_level_yt + i] ];  

                  }
               }

               GES.tileges.update_tilemaps(_smap.tilemaps[0],_smap.tilemaps[1],_smap.tilemaps[2]);
           
              _jugador.x = _nmap.tilemaps[0][0].length*16;          
              _level.x -=  _nmap.tilemaps[0][0].length*16;
           }

           if(f_dir==3)
           {
                  for(var k = 0;k<3;k++)
                  {
                  for(var j = 0; j<  _ht[0]; j++)
                  {

                  if(this.alien.objtile.alien[1]=="A")
                  {
                    _smap.tilemaps[k].splice(j,0, [...crear_array(_level_xt, 1), ..._nmap.tilemaps[k][_nmap.tilemaps[0].length-_ht[0]+ j]] );  
                  }

                  if(this.alien.objtile.alien[1]=="B")
                  {
                   
                    _smap.tilemaps[k].splice(j,0, [...crear_array(_level_xt, 1), 

                    ..._nmap.tilemaps[k][_nmap.tilemaps[0].length-_ht[0]+j].slice(

                       _nmap.tilemaps[k][j].length-_wt[0],   _nmap.tilemaps[k][j].length)] 

                    );  


                 // _smap.tilemaps[k].push( [...crear_array(_level_xt, 1), 
                   //     ..._nmap.tilemaps[k][j].slice(_nmap.tilemaps[k][j].length-_wt[0],   _nmap.tilemaps[k][j].length)] );  

                  }
                  

                  }
               }   
               

               GES.tileges.update_tilemaps(_smap.tilemaps[0],_smap.tilemaps[1],_smap.tilemaps[2]);
           
              _jugador.y =  _ht[0]*16;
              _level.y  -=  _ht[0]*16;

           }



           if(f_dir==4)
           {
            
               _jugador.x = _smap.tilemaps[0][0].length*16-_jugador.w;          
               
               for(var k = 0;k<3;k++)
               {
               for(var i = 0; i<  _ht[0]; i++)
                  {
                  if(this.alien.objtile.alien[1]=="A")
                    _smap.tilemaps[k][_level_yt + i] = [..._smap.tilemaps[k][_level_yt + i],  ..._nmap.tilemaps[k][i] ];  

                  if(this.alien.objtile.alien[1]=="B")
                    _smap.tilemaps[k][_level_yt + i] = [..._smap.tilemaps[k][_level_yt + i],  ..._nmap.tilemaps[k][_nmap.tilemaps[0].length-_ht[0]+i] ];  

                  }
               }   

               GES.tileges.update_tilemaps(_smap.tilemaps[0],_smap.tilemaps[1],_smap.tilemaps[2]);

           }


           if(f_dir==5)
           {
               _jugador.y = _smap.tilemaps[0].length*16-_jugador.h;          

               
               
               for(var k = 0;k<3;k++)
               {
               for(var j = 0; j<  _ht[0]; j++)
                  {

                  if(this.alien.objtile.alien[1]=="A")
                  {
                    _smap.tilemaps[k].push( [...crear_array(_level_xt, 1), ..._nmap.tilemaps[k][j]] );  
                  }


                  if(this.alien.objtile.alien[1]=="B")
                  {
                   
                  _smap.tilemaps[k].push( [...crear_array(_level_xt, 1), 
                        ..._nmap.tilemaps[k][j].slice(_nmap.tilemaps[k][j].length-_wt[0],   _nmap.tilemaps[k][j].length)] );  

                  }


                  }
               }   


               GES.tileges.update_tilemaps(_smap.tilemaps[0],_smap.tilemaps[1],_smap.tilemaps[2]);
              
           }


           GES.tileges.update_allmax();
           GES.tileges.refresh.force();


        },
        player_saveprops()
        {
         let _level   = $root.level;
         let _jugador = _level.jugador;




           this.p_save.xvelocity=_jugador.xvelocity;
           this.p_save.yvelocity=_jugador.yvelocity;

           this.p_save.modo = _jugador.modos.act.name;
           this.p_save.estado=_jugador.modos.modos.normal.estado;
           

           this.p_save.running=_jugador.modos.modos.normal.running;

        },
        player_setprops()
        {
         let _level   = $root.level;
         let _jugador = _level.jugador;

          _jugador.camera_offset.x = _jugador.x;
          _jugador.camera_offset.y = _jugador.y;

          _jugador.modos.modos.normal.estado=0;
          game.center_nivel(_jugador.camera_offset);
          _jugador.xvelocity = this.p_save.xvelocity;
          _jugador.yvelocity = this.p_save.yvelocity;
          _jugador.modos.modos.normal.estado = this.p_save.estado;
          _jugador.modos.modos.normal.running = this.p_save.running;


          if(this.p_save.modo=='escalera')
          {
        //    _jugador.modos.modos.escalera.check();
          _jugador.modos.set(this.p_save.modo, [fl( (_jugador.x+_jugador.w/2)/16 ),
                                                fl( (_jugador.y+_jugador.h/2)/16 )  ]);
          }
          

        },

        run()
        {

         if(game.escenario.act.can_slide!==1)return;


         let _level   = $root.level;
         let _jugador = _level.jugador;
         let _tilemaps = GES.tileges.tilemaps_all;

         //control end
         if(this.end_estado>0)
         {
          
            if(this.end_estado==1)
              {
                _jugador.x--;
               _jugador.estado_h=2;
               }
              
             if(this.end_estado==3)
             {
              _jugador.x++;
              _jugador.estado_h=3;
             }
              
         }

            //detectar slide
            if(this.estado==0 && 
               game.editor.estado==0 && game.escenario.act.name=='play_0' &&
               (_jugador.modos.act.name=='normal'|| _jugador.modos.act.name=='escalera') )
            {
             let _xt = fl((_jugador.x+_jugador.w/2)/16);
             let _yt = fl((_jugador.y+_jugador.h/2)/16);

              //detectar endpoint
              if(_tilemaps[3][_yt] && _tilemaps[3][_yt][_xt] && _tilemaps[3][_yt][_xt].id=='end_point')
              {
                let _tileobj = _tilemaps[3][_yt][_xt];

                if(_jugador.x<=0 && _jugador.xvelocity<=0)
                this.start_end(1,_tileobj);

                if(_jugador.y<=0 && _jugador.yvelocity<=0) 
                this.start_end(1,_tileobj);                
                
                if(_jugador.x+_jugador.w>=$gameges.tileges.xt_allmax * 16 && _jugador.xvelocity>=0)
                this.start_end(3,_tileobj);

                if(_jugador.y+_jugador.h>=$gameges.tileges.yt_allmax * 16 && _jugador.yvelocity>=0)
                this.start_end(3,_tileobj);

              }

              if(_tilemaps[3][_yt] && _tilemaps[3][_yt][_xt] && _tilemaps[3][_yt][_xt].id=='scroll_point')
              {
               let _tileobj = _tilemaps[3][_yt][_xt];

                //chocar izquierda
                if(_jugador.x<=0 && _jugador.xvelocity<0)
                this.start_alien(2, _tileobj);

                //chocar arriba
                if(_jugador.y<=0 && _jugador.yvelocity<0) 
                this.start_alien(3, _tileobj);
                
                //chocar derecha
                if(_jugador.x+_jugador.w>=$gameges.tileges.xt_allmax * 16 && _jugador.xvelocity>0)
                this.start_alien(4, _tileobj);

                //chacar abajo
                if(_jugador.y+_jugador.h>=$gameges.tileges.yt_allmax * 16 && _jugador.yvelocity>0)
                this.start_alien(5, _tileobj);

              }

            }


           //alienar
           if(this.estado==1)
           {
            let _alien = this.alien;
            //_level.y += (this.alien.y-_level.y)/30;
            //_level.x += (this.alien.x-_level.x)/30;
            if(_level.x< _alien.x) _level.x+=2;
            if(_level.x> _alien.x) _level.x-=2;
            if(_level.y< _alien.y) _level.y+=2;
            if(_level.y> _alien.y) _level.y-=2;


             if(_level.y >= this.alien.y-2 && _level.y <= this.alien.y+2 && 
                _level.x >= this.alien.x-2 && _level.x <= this.alien.x+2)
             {
                _level.y = this.alien.y;
                _level.x = this.alien.x;
                this.start_slide(this.alien.estado);
               
             }

           }

            
           if(this.estado==2)
           {
               _level.x+=3;
               _jugador.x-=0.2;
               if( (_level.x*-1 + game.wcanvas)  < this.maps_wh[1].w)
               {
                this.estado=0;

                _level.x = (this.maps_wh[1].w)*-1+game.wcanvas;
                
                game.mapcon.set_submap(this.alien.objtile.id_submap, {set_fondo:0,slide:1});
                
                $root.level.jugador.x = this.maps_wh[1].w-16;

                if(this.alien.objtile.alien[1]=='A') 
                  $root.level.jugador.y = this.p_save.y;

                if(this.alien.objtile.alien[1]=='B')
                 $root.level.jugador.y = this.maps_wh[1].h-(($gameges.tileges.yt_max-1)*16)+this.p_save.y;
                
                this.player_setprops();
               }
           }

           
           //arriba
           else if(this.estado==3)
           {
               _level.y+=3;
               _jugador.y-=0.3;

         //if( (_level.x*-1 + game.wcanvas)  < this.maps_wh[1].w)
         if( (_level.y*-1 + game.hcanvas)  < ($gameges.tileges.yt_max*16))
               {
                
               this.estado=0;
      

               let _lvx = $root.level.x;

                _level.y = 0;
                
                game.mapcon.set_submap(this.alien.objtile.id_submap, {set_fondo:0, slide:1});
                

                $root.level.jugador.y = this.maps_wh[1].h-16;
                if(this.alien.objtile.alien[1]=='A') 
                {
                  this.f_scroll.x+= _lvx;
                  $root.level.jugador.x = this.p_save.x;
                }

                if(this.alien.objtile.alien[1]=='B')
                {
                  if(this.alien.objtile.alien[0]=='A')
                 this.f_scroll.x+= this.maps_wh[1].w-($gameges.tileges.xt_max)*16;
                  if(this.alien.objtile.alien[0]=='B')
                  this.f_scroll.x+= this.maps_wh[1].w-this.maps_wh[0].w;  //$root.level.x;
                 //this.f_scroll.x+= $root.level.x;


                 $root.level.jugador.x = this.maps_wh[1].w-(($gameges.tileges.xt_max)*16)+this.p_save.x;
                }
                
                this.player_setprops();
               }
                  
           }



           else if(this.estado==4)
           {
               _level.x-=3;
               _jugador.x+=0.2;

               if( (_level.x*-1)  > this.maps_wh[0].w)
               {
                this.estado=0;

                this.f_scroll.x-=this.maps_wh[0].w;

                _level.x = 0;
                
                game.mapcon.set_submap(this.alien.objtile.id_submap, {set_fondo:0, slide:1});
                
                $root.level.jugador.x = 0;
              
                if(this.alien.objtile.alien[1]=='A') 
                  $root.level.jugador.y = this.p_save.y;

                if(this.alien.objtile.alien[1]=='B')
                 $root.level.jugador.y = this.maps_wh[1].h-(($gameges.tileges.yt_max-1)*16)+this.p_save.y;

                this.player_setprops();
               }
               
             }


           else if(this.estado==5)
           {
               _level.y-=3;
               _jugador.y+=0.4;

              
               if( (_level.y*-1)  > this.maps_wh[0].h)
               {
                this.estado=0;

                

               let _lvx = $root.level.x;

                _level.y = 0;
                
                game.mapcon.set_submap(this.alien.objtile.id_submap, {set_fondo:0, slide:1});
                
                $root.level.jugador.y = 0;
              
                if(this.alien.objtile.alien[1]=='A') 
                {
                  this.f_scroll.x+= _lvx;
                  $root.level.jugador.x = this.p_save.x;
                }

                if(this.alien.objtile.alien[1]=='B')
                {
                 //this.f_scroll.x+= this.maps_wh[1].w-($gameges.tileges.xt_max)*16;
                 //this.f_scroll.x+= $root.level.x;
                  if(this.alien.objtile.alien[0]=='A')
                 this.f_scroll.x+= this.maps_wh[1].w-($gameges.tileges.xt_max)*16;

                 if(this.alien.objtile.alien[0]=='B')
                 this.f_scroll.x+= this.maps_wh[1].w-this.maps_wh[0].w;  //$root.level.x;
                 //this.f_scroll.x+= this.maps_wh[0].w-($gameges.tileges.xt_max)*16;  //$root.level.x;


                 $root.level.jugador.x = this.maps_wh[1].w-(($gameges.tileges.xt_max)*16)+this.p_save.x;
                }
                
                this.player_setprops();
               }
                              
             }


           if(this.estado>=1&&this.estado<=5)
           {
            $gameges.tileges.x = _level.x * -1;
            $gameges.tileges.y = _level.y * -1;
           }



        }


      },//slidecon


      reset(_hard=0, _submap_id=0) 
      {
       if(_hard==0)
       game.mapcon.set_submap(_submap_id);
       
       else
       game.mapcon.set(this.map_master, _submap_id);

      },

       on_get_map()//empleado al guardar mapa; loguear
       {
       
       let _editor = game.editor.tile_editor;

       let _tilemap_obj = _editor.saveloop_objtile(_editor.tileges.tilemaps_all[3]);
           
        let _map = game.mapcon.map;
        let _copy = {};
           for(var i in _map)
           {
             if(i !=='submaps')
             _copy[i] = _map[i];

             else
             {
              let _submaps = [];
                for(var u of _map[i])
                {
                  let _submap = {};
                   for(var _i in u)
                   {
                    if(_i!=='tilemaps')
                    _submap[_i] = u[_i];
                    else
                    {
                    _submap[_i] = [u[_i][0],u[_i][1],u[_i][2],
                                  _editor.saveloop_objtile(u[_i][3])

                                 ];

                    }

                   }
                  _submaps.push(_submap);
                }
               _copy.submaps = _submaps;

             }

           }
            
             let _data = 
                  {
                   ...{
                       nombre: 'nuevo_mapa',
                       descripcion: "",
                      },

                    ..._copy
                  
                  }

          return(_data);
             

       },//on_get_map

       update_menu_submaps()
       {
         let _menu = game.editor.tile_editor.win.menu;
         _menu.Submaps['Submaps->'] = {};

        for(var i in this.map.submaps)
        {
         
          _menu.Submaps['Submaps->'][i]=(_menuclick)=>{
                                          
                                           game.mapcon.set_submap(_menuclick.nombre);

                                            };

        }

       },

       set_submap(f_id, f_data={})
       {

         let _data = {
                      ...{
                      set_fondo:1,
                      slide:0,
                      },
                      ...f_data
                     }


         this.submap = this.map.submaps[f_id];
         game.editor.tile_editor.mapcon.set(this.submap); 

         for(var i of this.submap.tilemaps[3])
         {
          for(var j of i)
          {
            if(j!==0)
            {
              j.in=0;
            }
          }
         }

        game.first_draw=1;
        $root.hijos_clip = [];
        game.objs = [];


           
        var _level = WIN.gameges.crear_vacio($root, {w: game.wcanvas, h: game.hcanvas });
        $root.level = _level;
        game.editor.tile_editor.offset_obj = _level;


        if(game.escenario.act.on_submapset)
        game.escenario.act.on_submapset();


        
        game.soundcon.temacon.ini_leveltema();


        if(_data.set_fondo)
        game.fondocon.set(this.submap.fondo);

        

       },
       set(_map=game.mapcon.map)
       {
        
        _map            = clone_object(_map);

        if(_map.submaps==undefined)
        {
          _map = {
                 ini_submap:0,
                 submaps: [_map]
                 };
        }
        for(var i in _map.submaps)
        {
           _map.submaps[i].id = i;
           if(_map.submaps[i].tema==undefined)
           {
            _map.submaps[i].tema={
                                  id:5,
                                  vol:0.4
                                 };
           }

           if(_map.submaps[i].fondo==undefined)
           {
            _map.submaps[i].fondo={
                                   id:'campo_a',
                                  };
           }
        }

        this.map = _map;
        this.map_master = clone_object(_map);


        this.update_menu_submaps();

        this.set_submap(this.map.ini_submap);





       }
 
    },//mapcon

    //|textoges
    textoges:
    {
     fuentes:
     {
      //"_data/images/fuente_tb4x4.png",

      tb4x4:
            {
            img_id:28,
            w:[4,4],
            h:[4,4],
            },

      tn5x9:
            {
            img_id:20,
            w:[5,5],
            h:[9,9],
            },

      nb8x8:
            {
            img_id:16,
            w:[8,8],
            h:[8,8],
            },
     tn8x8:
            {
            img_id:23,
            w:[8,8],
            h:[8,8],
            },

            tr8x8:
            {
            img_id:24,
            w:[8,8],
            h:[8,8],
            },

            ta8x8:
            {
            img_id:25,
            w:[8,8],
            h:[8,8],
            },


      tn10x18:
            {
            img_id:19,
            w:[10,10],
            h:[18,18],
            },
      tn10x18_b: //press start
            {
            img_id:21,
            w:[10,10],
            h:[18,18],
            },

      tnb10x18: //cerveza y libertad
            {
            img_id:30,
            w:[10,10],
            h:[18,18],
            },
      tng10x18: //cerveza y libertad gris
            {
            img_id:31,
            w:[10,10],
            h:[18,18],
            },

     },

    crear(f_donde=$root, f_data = {}, f_fuente='nb8x8')
    {
      let _fuente = this.fuentes[f_fuente];
      let _data ={
                  ...{
                     texto:'test',
                     x:0,
                     y:0,
                     //max_char:5,
                     gameges:WIN.gameges,
                     image:$LIB.IMAGES[_fuente.img_id],
                     canvas:DUMMY_CANVAS,
                     canvas_id:2,
                  
                     ..._fuente
                     },
                     ...f_data
                 }

     return(RPG.crear_texto(f_donde, _data));

    },
    
    },


    //|particon
    particon:
    {
     data:'',
     _data_default:
        {
         map:
          {
           act:'',
           pos:[0,0],
          },
          items:
          [
          'Bom y Bom'
          ],
          test_items:
           [
           'Nota de las acciones',
            'Bom y Bom',
            'Bom y Bom',
            'Bom y Bom',
            'Chocboy',
            'Chocboy'
           ],

           config:
           {
            sound:
             {
              vol_sound:0.1,
              vol_music:0,
             },

           },

           //|perfiles
           perfiles:
           {
            act:'',//obj
            id_act:'',//n

            set(f_id)
            {
             console.log('perfil act :' + f_id);
             this.id_act = f_id;
             this.act = this.perfiles[f_id];
             window.$perfil = this.act;


            },

            refill()
            {
             this.act.hp[0]=this.act.hp[1];
             this.act.pp[0]=this.act.pp[1];
            },
            set_var(f_n, f_var, _modo)
            {
                let _var = this.act[f_var];

                if(_modo=='set')
                _var[0]=f_n;
                if(_modo=='+')
                _var[0]+=f_n;
                if(_modo=='-')
                _var[0]-=f_n;

               if(_var[0]<0)
                 _var[0]=0;
               
               if(_var[0]>_var[1])
                  _var[0]=_var[1];

                if(game.escenario.act.hud.on_stats_update!==undefined)
                   game.escenario.act.hud.on_stats_update({value:_var, name:f_var, modo:_modo});

             

            },//set stats
            perfiles:
            [
                //maga
                {
                 name:'maga',
                 arma_name:'arco',
                 yvel_salto:5,
                 hp:[20,20],
                 pp:[20,20],
                 exp:[0,50],
                 atk:5,
                 lv:5,
                 ataques:[],
                },
           
                //bartender
                {
                 name:'bartender',
                 arma_name:'espada',         
                 yvel_salto:5,
                 hp:[19,19],
                 pp:[0,0],
                 exp:[0,50],
                 atk:5,
                 lv:5,
                 ataques:[],
                },                                
                
                //barba
                {
                 name:'barba',
                 arma_name:'espada',
                 yvel_salto:5,
                 hp:[20,20],
                 pp:[20,20],
                 exp:[0,50],
                 atk:5,
                 lv:5,
                 ataques:[],
                },
           
                //mundano
                {
                 name:'mundano',
                 yvel_salto:5,
                 arma_name:'arco',
                 hp:[20,20],
                 pp:[20,20],
                 exp:[0,50],
                 atk:5,
                 lv:5,
                 ataques:[],
                },
            ]

           }//stats

        },//particon

     _check_debug_partidanueva() //creacion de partida al acceder a escenas saltandose proceso habitual
     {
       if(this.data=='')
          this.nueva_partida(0);

     },
     nueva_partida(_goto_wmap=0)
     {
      this.data = clone_object(this._data_default);
      if(_goto_wmap==0)
        this.data.items=this.data.test_items;
      

      this.data.perfiles.set(1);//0-> 'maga'
      game.itemcon.on_particon_set();


       if(_goto_wmap)
       {
       let _script = cargar_txt("_data/maps/0_bar.json", (_map)=>{     
                             _map.ini_submap=6;
                             game.escenario.escenas.play_0.map = _map;

                             game.escenario.set('play_0');
                             game.fadecon.set('aclarar',   ()=>{});
                              

                                                      }  , 1);
       }


       //if(_goto_wmap)
       //game.escenario.set('play_0')


     },


    },//particon


    //|shootcon
    shootcon:
    {

      crear_flecha(f_dir, f_vel, f_data={})
      {
          let _p;
          if(f_dir==0)  _p ={buf:[[6,0]], flip:[0,0], xvelocity:-f_vel, yvelocity:0,      tilecol:{w:3,h:3,x:0,y:8}};
          if(f_dir==1)  _p ={buf:[[6,1]], flip:[0,0], xvelocity: 0,     yvelocity:-f_vel, tilecol:{w:3,h:3,x:8,y:0}};
          if(f_dir==2)  _p ={buf:[[6,0]], flip:[1,0], xvelocity: f_vel, yvelocity:0,      tilecol:{w:3,h:3,x:16,y:8}};
          if(f_dir==3)  _p ={buf:[[6,1]], flip:[0,1], xvelocity: 0,     yvelocity: f_vel, tilecol:{w:3,h:3,x:8,y:16} };

          this.crear_simple($root.level, {
                                        ..._p,
                                        ...f_data
                                          })

      },
      crear_simple(f_donde, f_data={})
      {
        let _data = setloop_prop(
                         {
                         detectar:[0,1], //player, jugador
                         x:0,
                         y:0,
                         buf:[[6,0]],
                         flip:[0,0],
                         remove_on_loop:0,
                         xvelocity:0,
                         yvelocity:0,

                         stats:{
                               atk:3
                               },
                        
                         tilecol:{
                                  _padre:'',
                                  estado:1,
                                  x:0,
                                  y:0,
                                  w:2,
                                  h:2,
                                  on_col()
                                  {
                                   this._padre.remove();
                                  },
                                  run()
                                  {
                                    let _tilemaps = $tileges.tilemaps;
                                    let _c = [[this.x       , this.y],
                                              [this.x+this.w, this.y],
                                              [this.x       , this.y+this.h],
                                              [this.x+this.w, this.y+this.h],
                                             ];
                                     let _xyids = [];
                                     for(var i=0;i<4;i++)
                                     {
                                      let _yt = fl( (this._padre.y+_c[i][1])/16 );
                                      let _xt = fl( (this._padre.x+_c[i][0])/16 );
                                      if(_tilemaps[1][ _yt ])
                                      {
                                       let _t = _tilemaps[1][ _yt ][ _xt];
                                       let _tp = $gameges.tileges.tiledata.col[_t];
                                       let _xvelocity = this._padre.xvelocity;
                                       if(this._padre._xvelocity!==undefined) _xvelocity = this._padre._xvelocity;
                                       let _yvelocity = this._padre.yvelocity;
                                       if(this._padre._yvelocity!==undefined) _yvelocity = this._padre._yvelocity;

                                       
                                       if(_t>0 && 
                                          ( 
                                            (_xvelocity>0 && this._padre.xprev<_xt*16    && _tp[0]==1)||
                                            (_xvelocity<0 && this._padre.xprev>_xt*16+16-this._padre.w && _tp[2]==1)||

                                            (_yvelocity>0 && this._padre.yprev<_yt*16    && _tp[1]==1)||
                                            (_yvelocity<0 && this._padre.yprev>_yt*16+16-this._padre.h && _tp[3]==1)   

                                            )
                                          )
                                       {
                                        let _xyid = (cerear(_yt,3)+cerear(_xt,3));
                                        if(_xyids.includes(_xyid)) continue;
                                        _xyids.push(_xyid);
                                        

                                        //flecha trampolin
                                        if(_t==150)
                                        {
                                          _tilemaps[1][ _yt ][ _xt]=160;
                                          $gameges.tileges.refresh.force();
                                          game.soundcon.play(18);

                                          if($jugador.x+$jugador.w>_xt*16 && $jugador.x<_xt*16+16 && 
                                            $jugador.y+$jugador.h<_yt*16+2&&$jugador.y+$jugador.h>_yt*16-16)
                                          {
                                           $jugador.yvelocity=-7; 
                                           
                                          }

                                          let _e = $WIN.gameges.cargar_clase($root.level, 1, 
                                                {anim_id:3, visible:false,remove_on_loop:0, xt_ini:_xt, yt_ini:_yt, x:_xt*16, y:_yt*16, tt:[0,10],enterframe(){ 
                                                   this.tt[0]++;
                                                   if(this.tt[0]>this.tt[1])
                                                   {
                                                     GES.tileges.tilemaps[1][this.yt_ini][this.xt_ini]=150;
                                                     $gameges.tileges.refresh.force();
                                                      this.remove();
                                                   }

                                                  } });
                                        }//150

                                        //cajas destruibles
                                        else if(_t==151||_t==152)
                                        {
                                          _tilemaps[1][ _yt ][ _xt]++;
                                          $gameges.tileges.refresh.force();
                                          game.soundcon.play(16,1,fl(Math.random()*2)+1);
                                        }
                                        else if(_t==153)
                                        {
                                           _tilemaps[1][ _yt ][ _xt]=0;
                                          $gameges.tileges.refresh.force(); 


                                           game.soundcon.play(16);
                                           
                                           game.misc.crear_rebotinero(
                                            {x:_xt*16,
                                             y:_yt*16,
                                             modo:'hp',
                                            }
                                            );

                                           game.particulas_con.caja_destrozada(_xt*16,
                                                                               _yt*16);

                                        }//153
                                        
                                        this.on_col();
                                        //break;
                                       

                                       }                                        
                                      }

                                     }//loop

                                  }//run

                                 },//tilecol

                         on_hit(f_modo)//'player', 'enem'
                         {
                          this.remove();
                         },
                         //draw_color:'blue',
                         _enterframe(){},
                         enterframe()
                         {
          
                           this._enterframe();
                          
                           if(this.tilecol.estado)
                              this.tilecol.run();

                           if(game.editor.estado==0)
                           {
                                //enemigos
                               if(this.detectar[1])
                               {
                                 for(var u of game.objs)
                                 {
                                   if(u._hitcon.estado==1 && u._hitcon?.detectar[1] && game.simple_hit_test(this, u))
                                   {
                                      u._hitcon.on_hit('bullet', {atk:this.stats.atk, clip:this});
                                      this.on_hit('enem');
                                   }

                                 }
                               }  
                               //jugador
                               if(this.detectar[0])
                               {
                                if($jugador._hitcon.estado==1 && $jugador._hitcon?.detectar[1] && game.simple_hit_test(this, $jugador))
                                   {
                                      $jugador._hitcon.on_hit('bullet',{atk:this.stats.atk, clip:this});
                                      this.on_hit('player');
                                   }
                                 
                               }  

                           }


                         if((this.xvelocity<0&&this.x<$root.level.x*-1) || (this.xvelocity>0&& this.x>$root.level.x*-1+game.wcanvas) ||
                            (this.yvelocity<0&&this.y<$root.level.y*-1) || (this.yvelocity>0&&this.y>$root.level.y*-1+game.hcanvas)  )
                           {
                            this.remove();
                           }

                          this.xprev = this.x;
                          this.yprev = this.y;

                          this.x = this.x + this.xvelocity;
                          this.y = this.y + this.yvelocity;

                         }
                       },
                       f_data
                      )
          
          let _clip = $WIN.gameges.cargar_clase(f_donde, 1, _data);

          
              _clip.xprev=_clip.x;
              _clip.yprev=_clip.y;
              _clip.tilecol.run();

          _clip.animdata.animations[0].remove_on_loop=_data.remove_on_loop;
            _clip.animdata.animations[0].flip = _data.flip;

          _clip.animdata.animations[0].buf=_data.buf;

          _data.tilecol._padre=_clip;

          
           
           return(_clip);


        }
    },


    //|dialogo
    dialogo:
    {
      dialogo: '',
      ini() {

        this.dialogo = RPG.crear_dialogo(WIN._bloque, {
          fuente: {
            img: $LIB.IMAGES[16],
          },
          teclado: WIN.teclado
        })

      },
      set() {
        this.dialogo.write.set(...arguments);

      },
      run() {
        if (this.dialogo !== '' && this.dialogo.write.estado !== 0)
          this.dialogo.run();

      },
      on_end()
      {

      },
      end() {
        if (this.dialogo !== '' && this.dialogo.write.estado !== 0) {
           this.dialogo.write.on_end();

        }

      },

    },


    //|pausecon
    pausecon:
    {
      
      estado:0,
      set(f_id)
      {

      },
      on_keydown(e)
      {

         if(game.escenario.act.can_pause)
         { 
          if(e.key=='Enter')
          {
          
           _root.propagar_enterframe = this.estado;
           _root.enabled_enterload   = this.estado;

           this.estado = flipbin(this.estado);
           
           if(this.estado)
           {
           
           this.temaprev = game.soundcon.temacon.act;

           let _start = this.temaprev.startTime;
           let _curr = AUDIO.ctx.currentTime;
           let _dur = this.temaprev.buffer.duration;


           let _sec = (_curr-_start);
           while(_sec>_dur)
           {
            _sec-= _dur;
           }
               
           this.resume_time = _sec;

              //alert(_sec)


           game.soundcon.temacon.stop(); 



           }
           else
           {
            
            game.soundcon.temacon.play(this.temaprev.id, this.temaprev.gain.gain.value, 0, this.temaprev.loop,   0, [this.resume_time,undefined] ); 
            game.soundcon.temacon.act.startTime -= this.resume_time;



            //play(f_id, f_gain=1, f_pitch=0, f_loop=0, f_time=0, f_offset=undefined)


           }
           



          }

         }

      }


    },

    //|escenario
    escenario:
    {
      act: '',
      set(_name) {

        //  game.first_draw =1;
        
        game.fondocon.clear();
        game.soundcon.temacon.stop();
        game.mapcon.slidecon.clear();

        $root.hijos_clip = [];
        game.objs = [];

        game.dialogo.end();
        game.first_draw=1;

        GES.clear_all();
        GES._enterframe = () => { };
        GES.fondoges.fondos = [];
        GES.tileges.estado = 0;
        GES.fondoges.estado = 0;
        GES.tileges.remade_tilemaps(10, 10, 0);
        game.mapcon.map = { tilemaps: GES.tileges.tilemaps_all };
        GES.tileges.x = 0;
        GES.tileges.y = 0;


        for (var u of GES.canvasses)
        {
             u.no_clear = 0;
             for(var b of u.buffers)
             {
              b.clear();
             }
        }
          

        GES.tileges.refresh.force();


        delete $root.level;
        $root.x = 0;
        $root.y = 0;

        this.act = this.escenas[_name];

        if (this.act.editor?.img_id != undefined) {
          game.editor.iniset({ img_id: this.act.editor.img_id });
        }
        else {
          game.editor.cerrar();
        }


 

        if (this.act.editor?.tiledata_id != undefined) 
          {
            GES.tileges.tiledatas.set(this.act.editor.tiledata_id);
          }

        this.act.load();

        if (this.act.editor && $root.level)
          game.editor.tile_editor.offset_obj = $root.level;


      },

      on_keydown(e)
      {

      },
      //|enterframe
      enterframe() {

        if(WIN.get_title()!== 'Watons, legend of pipi [' + game.escenario.act.name + ']' )
           WIN.set_title('Watons, legend of pipi [' + game.escenario.act.name + ']');


              

        

        if (this.act !== '') {
          this.act.enterframe();

              //|optimizacion
               if($root?.level)
               {
                  $root.level.hijos_clip.sort(function(a,b){
                                       
                                         if(a._z==undefined)
                                           a._z=0;
                                         
                                         if(b._z==undefined)
                                           b._z=0;
                                         
                                          if(a._z<b._z)
                                            return(-1)
                                          
                                          if(a._z>b._z)
                                            return(1)
                                          
                                          return(0)
                    })
               }


          game.efectocon.run();
          game.fondocon.run();
          game.dialogo.run();
          game.mapcon.run();
          if(game.escenario.act.can_itemcon)
             game.itemcon.run();

        }

      },

      //|escenas
      escenas:
      {
        //|intro
        intro_0: {
          name: 'intro_0',
          logo: '',
          tt: 0,
          _tt: [0, 15],
          load() {
            this.tt = 0;
            //var _level = WIN.gameges.crear_vacio($root,{w: fl(WIN._bloque.wr/2) ,h: fl(WIN._bloque.hr/2) });
            //$root.level = _level;    

             

            let _logo = this.logo = WIN.gameges.crear_imagen($root, 12, { x: 60, y: 55, w: 6 * 16, h: 1 * 16, cut_cords: { x: 0 * 16, y: 1 * 16, w: 6 * 16, h: 1 * 16 } });
            _logo.filter = { opacity: 100 }
            _logo.visible = false;

          },
          enterframe() {
            this.tt++;
            if (this.tt > 30) {
              this.logo.visible = true;
              if (this.tt > 60) {
                this._tt[0]++;
                if (this._tt[0] > this._tt[1]) {
                  this._tt[0] = 0;
                  this.logo.filter.opacity -= 20;
                  if (this.logo.filter.opacity < 0)
                  {
                    this.logo.filter.opacity = 0;
                    game.escenario.set('intro_1')
                  }

                }
              }
            }

          }
        },

        //|intro1
        intro_1: {
          name: 'intro_1',
          cinema: '',//clip
          c_id: 0,
          tt: [0, 10],
          estado: 0,
          set_cine(f_n) {

            let _cinema = this.cinema;
            _cinema.cut_cords = {
              x: 0,
              y: f_n * (5 * 16),
              w: 12 * 16,
              h: 5 * 16
            };
          },
          end_line()//llamado al terminar parrafo cinematico
          {
            this.estado = 1;
          },
          load() {
            this.c_id = 0;
            this.tt[0] = 0;
            this.estado = 0;

            game.soundcon.temacon.play(10,0.5,0,1);

            let _cinema = this.cinema = WIN.gameges.crear_imagen($root, 15, {
              x: 16, y: 16,
              w: 12 * 16, h: 5 * 16,
              cut_cords: { x: 0 * 16, y: 0 * 16, w: 10 * 16, h: 5 * 16 }
            });
            _cinema.filter = { opacity: 0 };
            this.set_cine(this.c_id);

            GES.canvasses[2].no_clear = 1;

            let _script = '{"speed":[4,4], "pause":1000, "script":"game.escenario.act.end_line()" } {"next":"" }';
            let _s0 = '{"speed":[20,20]}';
            let _s1 = '{"speed":[5,5]}';

            game.dialogo.set(['{"id":"main","m_speed":[4,4]}Hace miles de aos, en la Constelacion 73'+_s0+'...' + _script ,
               'Existio lo que era llamado '+_s1+'el bar de los amiguitos.'+ _script,
               'Un magico lugar que acogia a las solitarias almas del multiverso.'+ _script,
               'Tiempos felices. Mas nadie hacia presagiar lo que el futuro les deparaba...'+'{"pause":9999999999999}',
              {
                asas: ['daasd']
              }
            ]

            );

            //draw_letra({canvas:GES.canvasses[2], char:'E', x:0,y:0, w:[8,8],h:[8,8], img:$LIB.IMAGES[16]})
          },
          enterframe() {
            let _cinema = this.cinema;

             //saltar
             if($TECLADO.get('enter',2)==1)
             {
             game.escenario.set('menu_0'); 
             }
             

            if (this.estado == 0) {
              this.tt[0]++;
              if (this.tt[0] > this.tt[1]) {
                this.tt[0] = 0;
                _cinema.filter.opacity += 15;
                  if (_cinema.filter.opacity >= 100)
                  {
                    _cinema.filter.opacity=100;
                    //this.estado = 1;
                  }
              }
            }
            if (this.estado == 1) {
              this.tt[0]++;
              if (this.tt[0] > this.tt[1]) {
                this.tt[0] = 0;
                _cinema.filter.opacity -= 15;
                if (_cinema.filter.opacity <= 0) {
                  _cinema.filter.opacity = 0;
                  this.estado = 0;
                  this.c_id++;
                  this.tt[0] = -30; //forma poco 'limpia' de retrasar aparicion
                  this.set_cine(this.c_id);
                }
              }
            }


          }
        },

        //|menu_0
        menu_0: {
          name: 'menu_0',
          editor: { img_id: [5,17], tiledata_id: 1 },
          textos:{},
          estado:0,
          estado_2:0,
          tt:[0,30,0],
          f_tt:[0,10],

          load() {//menu
            this.estado=0;
            this.estado_2=0;
            this.tt=[0,30,0];
            GES.tileges.estado = 1;
            GES.tileges.images[0] = $LIB.IMAGES[5];

            GES.fondoges.fondos = [];
            GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 10, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 11, x: 0, y: 0 }); //canvasses gameges pintado

            GES.tileges.tilemaps[0][0][0]=1;
            let _map = $LIB.CLASES[11];
            
            GES.tileges.update_tilemaps(_map.tilemaps[0], _map.tilemaps[1], _map.tilemaps[2]);
            
            GES.fondoges.fondos[2].x=-30;
          //  var _level = WIN.gameges.crear_vacio($root,{w: fl(WIN._bloque.wr/2) ,h: fl(WIN._bloque.hr/2) });
            //    $root.level = _level;    

            let _logo = this.logo = WIN.gameges.crear_imagen($root, 12, 2,  
               {x: 8*4-5, y: 2, w: 10 * 16, h: 6 * 16, 
               cut_cords: { x: 0 * 16, y: 2 * 16, w: 10 * 16, h: 6 * 16 } });

           
           this.textos.presstart = game.textoges.crear($root, {x:50,y:90, texto:'PRESS START'},'tn10x18_b')
           this.textos.cervezaylibertad = game.textoges.crear($root, {x:20,y:170, texto:'Cerveza y Libertad'},'tnb10x18')
           

          },
          enterframe() {
            //this.textos.presstart.y++;
            
            this.f_tt[0]++;
            if(this.f_tt[0]>this.f_tt[1])
            {
              this.f_tt[0]=0;
              GES.fondoges.fondos[1].x--;
            }
            
            if(this.estado==1)
            {
                 let _empezar = this.textos.empezar;
                 let _opciones= this.textos.opciones;
                 
                 if($TECLADO.get('izq',2)==1)
                 {
                  game.soundcon.play(11);
                  this.estado_2=0;
                }
                if($TECLADO.get('der',2)==1)
                 {
               game.soundcon.play(11);
                  this.estado_2=1;
                }

                    if(this.estado_2==0)
                    {
                     _empezar.y  = _empezar.ini_y-5;
                     _opciones.y = _opciones.ini_y;
                    if($TECLADO.get('z',2)==1)
                      {
                        this.estado=3;
                        game.soundcon.play(12);

                         game.fadecon.set('oscurecer',   ()=>{
                       
                         game.particon.nueva_partida(1);



                       } );
                      
                      //game.particon.nueva_partida(1);
                      

                      }
                    }
                    if(this.estado_2==1)
                    {
                     _empezar.y  = _empezar.ini_y;
                     _opciones.y = _opciones.ini_y-5;
                      
                    }

            }

            if(this.estado==0)
            {
              
               if($TECLADO.get('z',2)==1)
               {
                //this.textos.presstart.set_text('aa');
               this.textos.presstart.visible=false;
               this.estado=1;

       
               this.textos.empezar = game.textoges.crear($root,  {x:20,y:100,   texto:'Empezar'},'tn10x18_b')
               this.textos.opciones = game.textoges.crear($root, {x:120,y:100,  texto:'Opciones'},'tn10x18_b')
               this.textos.empezar.ini_x = this.textos.empezar.x;
               this.textos.empezar.ini_y = this.textos.empezar.y;

               this.textos.opciones.ini_x = this.textos.opciones.x;
               this.textos.opciones.ini_y = this.textos.opciones.y;
               
               }
              this.tt[0]++;
              if(this.tt[0]>this.tt[1])
              {
                
                this.tt[0]=0;
                if(this.tt[2]==0)
                {
                 this.textos.presstart.y+=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==1)
                {
                 this.textos.presstart.y+=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==2)
                {
                 this.textos.presstart.y-=2;
                 this.tt[2]++;
                }
                else if(this.tt[2]==3)
                {
                 this.textos.presstart.y-=2;
                 this.tt[2]=0;
                }

              }
              
            }

          }
        },


        //|wmap
        wmap:
        {
          name: 'wmap',
          editor: { img_id: [13,17],   tiledata_id: 0 },
          can_itemcon:1,
          

          set_clearpath(f_clear)
          {
            let _c16 = $root.level.jugador.get_c16();
            if(f_clear.toString()!=='0,0,0,0')
            {
            $root.level.jugador.propagar.ini(_c16.x, _c16.y, f_clear);  
            }
            
             
          },
          on_nuevapartida()
          {
          let _mapcon = this.mapcon;
          },
          on_mapoint_openselect(f_obj)
          {
           this.hudbottom.on_mapoint_openselect();
          },
          on_mapoint_start(f_obj)
          {
   
             game.fadecon.set('oscurecer',   ()=>{ 

                 let _script = cargar_txt("_data/maps/"+f_obj.mapa, (_map)=>{     

                             
                             game.escenario.escenas.play_0.map = _map;

                             game.escenario.set('play_0');



                              game.fadecon.set('aclarar',   ()=>{ })

                                                      }  , 1);
          

                })


            

           // this.hudbottom.on_mapoint_start();


           console.log('mapoint start')
          },
          on_mapoint_stand(f_obj)
          {
           this.hud.update_level_titulo(f_obj.mapa);
           console.log('mapoint stand')
          },
          on_mapoint_leave(f_obj)
          {
            //this.hud.update_level_titulo('');
             console.log('mapoint leave')
          },

          mapcon:
          {
            savepos: { x: 2, y: 5 },//en tile

            _ids:
            {
            test:9,
            anonimo:0
            },

            get(f_name)
            {
            let _id = this._ids[f_name];
            return($LIB.CLASES[_id]);
            },
            set(f_name)
            {
            let _map = this.get(f_name);
            game.escenario.set('wmap')
            },

          },//mapcon

          hud:
          {
            _padre: '',
            hud: '',
            textos:{},
            
            update_level_titulo(f_texto)
            {
              //provisional
              let _texto= "";
             for (var i =0;i<f_texto.length-5;i++)
             {
              let c = f_texto.charAt(i);
              if(c=='_')c=" ";
              _texto+=c;
             }
            

            this.textos.level_titulo.set_text(_texto);
            this.textos.level_titulo._onload=()=>
                          {
                        // this.textos.level_titulo.visible=true;
                         this.textos.level_titulo.x= game.wcanvas/2-this.textos.level_titulo.w/2;
                          }

            },

            ini() {
              let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: game.wcanvas,
                  h: 16*1,
                  y: 0,
                  draw_color: 'black'
                });

              this.textos.level_titulo = game.textoges.crear(_hud, {x:2,y:2, texto:' '})
              this.update_level_titulo('')

            },

          },
          //|hudbottom wmap
          hudbottom:
          {
            hud:'',
            estado:0,
            y_open: 16*9,
            on_mapoint_openselect()
            {
             this.estado=1;
            },
            
            selector:
            {
              _padre:'',
              caras:[],
              id:'',
              selector:'', //obj
              blink_tt:[0,10],
              set(f_id)
              {
               this.id=f_id;

               this.blink_tt[0]=-10;
               this.selector.visible=1;
               this.selector.x = this.caras[this.id].x;
               
               game.particon.data.perfiles.set(this.id);
               //game.particon.data.id_act = this.id;

              },
              ini()
              {
                let _hud = this._padre.hud;
                
                //crear imagenes watons
                for(var i =0;i<4;i++)
                {
                this.caras.push( WIN.gameges.crear_imagen(_hud, 12, 2, { x: i*32 + (16*(i+1) ), y: 8, w: 32,h:32,
                                         cut_cords:{x:i*32,y:8*16, w:32, h:32  }  })
                                );
                }

                this.selector = WIN.gameges.crear_imagen(_hud, 12, 2, { x: (0)*32 + (16*((0)+1) ), y: 8, w: 32,h:32,
                                                         cut_cords:{x:4*32,y:8*16, w:32, h:32  }  });
              
                
                this.set(game.particon.data.perfiles.id_act);


              },
                run() //lamado solo si hudbottom.estado==1
                {

                  if(this._padre.estado==2)
                  {
                    
                    this.blink_tt[0]++;
                    if(this.blink_tt[0]==this.blink_tt[1])
                    {
                      this.selector.visible=swap_bin(this.selector.visible);
                      this.blink_tt[0]=0;
                    }

                    if(WIN.teclado.get('izq',2)==1 && this.id>0)
                    {
                    game.soundcon.play(11);
                    this.set(this.id-1);
                    }
                    
                 
                    if(WIN.teclado.get('der',2)==1 && this.id<3)
                    {
                      game.soundcon.play(11);
                      this.set(this.id+1);
                    }
                    

                    if(WIN.teclado.get('z',2)==1)
                    {
                      game.soundcon.play(12);
                    $root.level.jugador.estado=6;
                    this._padre.estado=3;  
                    this.selector.visible=1;
                    }

                 } 
                 


                },

            },//selector

            ini()
            {
               this.estado=0;
                let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: game.wcanvas,
                  h: 16*4,
                  x: 0,
                  y: 17*11,
                  draw_color: 'black'
                });
              
                this.selector._padre = this;
                this.selector.ini();
                

            },
            run()
            {
              this.selector.run();

               if(this.estado==1)
               {
                this.hud.y += (this.y_open-this.hud.y)/10;
                if(this.hud.y<=this.y_open+1)
                {
                  this.hud.y=this.y_open;
                  this.estado = 2;  
                }
               }
            }
           

          },

          load() {//wmap
            game.particon._check_debug_partidanueva();
            this.hud._padre = this;

            GES.tileges.images[0] = $LIB.IMAGES[13];
            GES.tileges.estado = 1;

            GES.fondoges.fondos = [];
            GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 10, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.ini(0, { image: 11, x: 0, y: 0 }); //canvasses gameges pintado
            GES.fondoges.estado = 1;

            if(this.map == '')
               this.map = $LIB.CLASES[9];  

            game.mapcon.set(this.map,0);

            this.map = game.mapcon.map;


          },
          map:'',

          on_submapset()
          {
          let _savepos = this.mapcon.savepos;
          WIN.gameges.cargar_clase($root.level, 8, { x: _savepos.x * 16, y: _savepos.y * 16, nombre: 'jugador' }); //jugador
          window['$jugador'] = $root.level.jugador;

            //$root.level.jugador.loadframe();
            //$root.level.jugador.loadframe_state = 1;
          
          if(game.editor._psave!==undefined)
          {
            $root.level.jugador.x = game.editor._psave.x;
            $root.level.jugador.y = game.editor._psave.y;
            game.editor._psave=undefined;
          }
          $root.level.jugador.camera_offset.update();

          game.center_nivel($root.level.jugador.camera_offset);
 

          this.hud.ini();
          this.hudbottom.ini();
          },

          enterframe() {
            
            this.mapcon.savepos.x = fl($root.level.jugador.x / 16);//provisorio
            this.mapcon.savepos.y = fl($root.level.jugador.y / 16);//provisorio
            this.hudbottom.run();

            game.center_nivel($root.level.jugador.camera_offset);

            //GES.canvasses[2].no_clear=1;
            //GES._enterframe=()=>{GES.canvasses[2].draw.line(0,0,100,100);}

          }


        },//map



        //|play
        play_0:
        {
          name: 'play_0',
          editor: { img_id: [5,17], tiledata_id: 1 },
          can_pause:1,
          can_slide:1,
          can_itemcon:1,

          map:'',
                          //{value, name, modo}
          tt_dead:[0,0], //def en ini
          hud:
          {
            _padre: '',
            
            barras:{exp:'',hp:'',pp:''  },
            textos:{},
            estado:0,

            set_lv()
            {
             let _tx = this.textos.lv;
                 _tx.set_text("Lv:" + $perfil.lv);

            },

            ini() {
              this._padre.tt_dead=[0,60];
              this.estado=0;
              let _hud = this.hud = WIN.gameges.crear_vacio($root, 2,
                {
                  w: game.wcanvas,
                  h: 16,
                  y: 11 * 16,
                  draw_color: 'black'
                });
               let _stats = game.particon.data.perfiles.act;

               this.barras.exp = game.crear_hudbarra(_hud, 
                 {valores:_stats.exp, x:1, y:1, w:190, h:3, texto:{x:0,y:-1,texto:'Ex'}, colores:['rgb(33,33,33)','white'  ]  })

               this.barras.hp = game.crear_hudbarra(_hud, 
                 {valores:_stats.hp, x:1, y:5, w:_stats.hp[1]*2, h:4, texto:{x:0,y:0,texto:'HP'}, colores:['rgb(54,54,54)',
                 'rgb(319,151,139)']  })
                 //'rgb(107,113,180)']  })
               
               this.barras.pp = game.crear_hudbarra(_hud, 

                 {valores:_stats.pp, x:1, y:10, w:_stats.pp[1]*2, h:4, texto:{x:0,y:0,texto:'PP'}, colores:['rgb(54,54,54)',
                 'rgb(107,113,180)']})
                // 'rgb(101,189,134)']})

                this.textos.lv=game.textoges.crear(_hud, {x:202, y:0, texto:"Lv:0"},"tb4x4");

                this.set_lv();


            },
            run()
            {
            
            

            if(this.estado=='hit_hp')
               {
                //this.hudbarras.hp.texto.y++;

               }


               

            },
          

          on_stats_update(f_obj)
          {
           this._padre.hud.barras[f_obj.name].set(f_obj.value[0], 'set');
           
           //this.estado='hit_hp';

           if(f_obj.name=='hp'&&f_obj.value[0]<=0)
           {
            
             game.escenario.escenas.play_0.vidalost_con.on_vidalost();
            
           }

          },

          update_hudbarras()
          {
            let _stats = game.particon.data.perfiles.act;
            for(var i in this.barras)
            {
              this.barras[i].set(_stats[i][1], 'set');
            }

          },

          },//hud

          vidalost_con:
          {
            _padre:'',
           tt:[0,120, 205],
           estado:0,
           ini()
           {
             this.tt[0]=0;
             this.estado=0;
           },
           run()
           {
              if(this.estado)
              {
                this.tt[0]++;

                if(this.tt[0]==this.tt[2])
                {
                  this.estado=0;
                  this.tt[0]=0;

                  game.particon.data.perfiles.refill(); 


                 game.escenario.set('wmap');
                 game.fadecon.set('aclarar',   ()=>{});


                }
                if(this.tt[0]==this.tt[1])
                {




                 game.fadecon.set('oscurecer',   ()=>{
                
                 });


                }
              }
           },
              on_vidalost()
              {
                this.estado=1;
                 

              },

          },//vidalost_con
          

           load()  //play
           {
            //game.soundcon.temacon.play(5,0.2,0,1);

            this.hud._padre = this;
            this.vidalost_con._padre = this;

             this.vidalost_con.ini();

            game.particon._check_debug_partidanueva();
            if(this.map == '') //por precaucion
            this.map = $LIB.CLASES[7];  
            
            GES.tileges.estado = 1;
            GES.tileges.images[0] = $LIB.IMAGES[5];


            
            
            game.mapcon.set(this.map, 0);

          },

          on_submapset()
          {
          let _startpoint = game.find_in_obj_layer('id','start_point');
          if(!_startpoint)
            _startpoint={x:3,y:3, direccion:1};

          WIN.gameges.cargar_clase($root.level, 0, { x: _startpoint.x * 16, y: (_startpoint.y+1) * 16-25, nombre: 'jugador'}); //jugador
          window['$jugador'] = $root.level.jugador;
          $root.level.jugador.modos.modos.normal.estado=_startpoint.direccion;
          

            //$root.level.jugador.loadframe();
            //$root.level.jugador.loadframe_state = 1;

          //editor
          if(game.editor._psave!==undefined)
          {
            $root.level.jugador.x = game.editor._psave.x;
            $root.level.jugador.y = game.editor._psave.y;
            game.editor._psave=undefined;
          }


          $root.level.jugador.camera_offset.update();
          

          this.hud.ini();


          game.center_nivel($root.level.jugador.camera_offset);

          

          },

          enterframe() {
                                  
          this.vidalost_con.run();
          this.hud.run();
          let _jugador = $root.level.jugador;
         
          if(game.mapcon.slidecon.estado==0) 
          game.center_nivel(_jugador.camera_offset);
          


            //GES.canvasses[2].no_clear=1;
            //GES._enterframe=()=>{GES.canvasses[2].draw.line(0,0,100,100);}
          },

         

        },//play_0

      },//escenas

    },//escenario

    //|ini
    ini() {

      WIN.teclado.add_keydown(bindear_(game.on_keydown, game));
      WIN.cursor.add_mousedown(bindear_(game.on_mousedown, game));
      WIN.cursor.add_mouseup(bindear_(game.on_mouseup, game));
      WIN.cursor.add_mousemove(bindear_(game.on_mousemove, game));

      
      var ARR_CAN = [crear_canvas(WIN._bloque, 2, 0, 0, [0,0], [0,0], {},{modo_borde:'sobrepuesto'}),
                     crear_canvas(WIN._bloque, 2, 0, 0, [0,0], [0,0], {},{modo_borde:'sobrepuesto'}),
                     crear_canvas(WIN._bloque, 2, 0, 0, [0,0], [0,0], {},{modo_borde:'sobrepuesto'}),
                     crear_canvas(WIN._bloque, 2, 0, 0, [0,0], [0,0], {},{modo_borde:'sobrepuesto'}),
      ];


      game.wcanvas = ARR_CAN[0].obj.width;
      game.hcanvas = ARR_CAN[0].obj.height;
      
      //alert(WIN._bloque.wr + ' ' + game.wcanvas*2);  
      //WIN.set_literal_size(game.wcanvas*2, game.hcanvas*2);


      window['GES'] = GAME.crear_gestor(WIN, ARR_CAN,
        {
          donde: WIN._bloque,
          w: ARR_CAN[0].wr / 2,
          h: ARR_CAN[0].hr / 2
        });
      game.gestor = GES;

      GES.fondoges.ini(0, { image: 9, x: 0, y: 0 });  //canvasses gameges pintado
      GES.fondoges.estado = 0;

      GES.tileges.ini_with_buffers([1, 1, 2],
        //ini data
        {
          id: 5,
          wt: 16, ht: 16,
          yt_max: 12, xt_max: 12+2
        }
      );
      GES.tileges.estado = 0;
      
      GES.tileges.tiledatas.tiledatas=[];
      GES.tileges.tiledatas.add($LIB.CLASES[10], 0);//worldmap
      GES.tileges.tiledatas.add($LIB.CLASES[6], 1);//main game


      GES.tileges.on_draw_stroke = function (_modo) {
        if (_modo == 'all')
          game.first_draw = 0;
      }

      GES.tileges.on_draw_tile = function (_y, _x, _modo) {
        
        if(game.mapcon.slidecon.estado!==0)return;

        if (_modo == 'x' || _modo == 'y' || (_modo == 'all' && game.first_draw == 1)) {

          let _maps = GES.tileges.tilemaps_all;
          if (_maps[3][_y] &&
              _maps[3][_y][_x] !== 0 && _maps[3][_y][_x] !== undefined && _maps[3][_y][_x].in == 0) {
            let u = _maps[3][_y][_x];
            u.x = _x;
            u.y = _y;
            
                       game.cargar_enemigo(
                       {
                       x: _x,
                       y: _y,
                       mapdata: u,
                       }
                       );
            console.log('objeto ' + u.id + ' creado')


          }
        }
      }


      $root.w = fl(WIN._bloque.wr / 2);
      $root.h = fl(WIN._bloque.hr / 2);

      game.dialogo.ini();

      crear_enterframe(_root, WIN, function () 
      {
        //workaround
       _root.set_$(WIN);
      
       
       
       game.escenario.enterframe(); 
       
       


      });

      game.particon.nueva_partida(0);
      game.escenario.set('menu_0');


    },//ini

    //|editor
    editor:
    {
      estado: -1, //0 = modo juego; 1 = modo editor; -1 = desactivado
      tile_editor: '',
      on_keydown(_k) {
    
         if(this.estado>=0)
         {
            if (_k.key == 'Escape' && _MODO_DESARROLLO) 
            {
            game.first_draw=1;
            this.set(swap_bin(this.estado),1 );
            }
         }

      },
      on_mousedown(e) {
        if(this.estado==1) 
        {
        let _xm = (e.offsetX / 2) - $root.level.x;
        let _ym = (e.offsetY / 2) - $root.level.y;
          for (var u of game.objs) {
            if (game.simple_hit_test(u, { x: _xm, y: _ym, w: 1, h: 1 })) {
              
              
              this.tile_editor.estado_tiledraw = 0;
              //this.tile_editor.objcon.set(fl(_xm/16), fl(_ym/16));
              this.tile_editor.objcon.set(u.mapdata.x, u.mapdata.y);

              this.grab.obj = u;
              this.grab.plus[0] = u.x - _xm;
              this.grab.plus[1] = u.y - _ym;

              //actualizar capa obj
             let _obj = this.grab.obj;
             let _mapdata = _obj.mapdata;

             game.mapcon.submap.tilemaps[3][_mapdata.y][_mapdata.x] = 0;
             break;

             }
          }
        }

      },

      on_mousemove(e) {
        if (this.estado==1 && this.grab.obj !== '') {
          let _obj = this.grab.obj;
          if(e.offsetX<0) e.offsetX=0;
          if(e.offsetY<0) e.offsetY=0;
          

          let _xt = fl(((e.offsetX / 2) - $root.level.x + this.grab.plus[0] + _obj.w / 2) / 16);
          let _yt = fl(((e.offsetY / 2) - $root.level.y + this.grab.plus[1] + _obj.h / 2) / 16);
          
          

          _obj.x = _xt * 16;
          _obj.y = _yt * 16;

        }

      },
      on_mouseup(e) {
        if(this.estado==1 && this.grab.obj!== '')
        {
          this.tile_editor.estado_tiledraw=1;

          let _obj = this.grab.obj;
          let _mapdata = _obj.mapdata;
          let _xt = fl(((e.offsetX / 2) - $root.level.x + this.grab.plus[0] + _obj.w / 2) / 16);
          let _yt = fl(((e.offsetY / 2) - $root.level.y + this.grab.plus[1] + _obj.h / 2) / 16);
          _obj.x = _xt * 16;
          _obj.y = _yt * 16;
              if(_xt<0) _xt=0;
              if(_yt<0) _yt=0;
          
          //si esta ocupado el espacio por otro objeto
          if(game.mapcon.submap.tilemaps[3][_yt][_xt]!==0)
          {
            game.mapcon.submap.tilemaps[3][_yt][_xt]._clip.remove();
          }

          _mapdata.x = _xt;
          _mapdata.y = _yt;
          //game.map.maps[0][_yt][_xt]=1;     //test
          game.mapcon.submap.tilemaps[3][_yt][_xt] = _mapdata;

          this.grab.clear();

        }        
      },
 
        set(f_n = this.estado, f_mapupdate=0)//cambio estado
        {
          console.log("set editor: "+f_n);
          this.estado = f_n;
          this.tile_editor.estado = f_n;

          this.tile_editor.set_capa_act(); //forzar actualizacion titulo ventanaeditor
          if (this.estado == 1) { //activar
              


            this.grab.clear();
            WIN.macrobloque.header.titulo.obj.style.background = 'gray';
            let _jugador = $root.level.jugador;
            this._psave = { x: _jugador.x, y: _jugador.y };


            if(f_mapupdate)
            {
            game.mapcon.map.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map_master.submaps[game.mapcon.submap.id]);
            game.mapcon.reset(0, game.mapcon.submap.id);
            }

            //$root.level.jugador.x = _psave.x;
            //$root.level.jugador.y = _psave.y;
          }
          else { //editor to 0

           if(game.mapcon.submap!=='' && f_mapupdate)
            game.soundcon.temacon.ini_leveltema();
            //game.soundcon.temacon.ini_leveltema();
            
            if(f_mapupdate)
            {

            game.mapcon.map_master.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map.submaps[game.mapcon.submap.id]);
            //game.mapcon.map_master.submaps[game.mapcon.submap.id]=clone_object(game.mapcon.map.submaps[game.mapcon.submap.id]);
            }

            this.grab.clear();
            WIN.macrobloque.header.titulo.obj.style.background = 'lightgray';
          }
        },


      grab: {
        obj: '',
        plus: [0, 0],
        clear() {
          this.obj = '';
          this.plus = [0, 0];
        }

      },
     
      cerrar() { //llamado al cambiar a una escena sin editor
        if(this.tile_editor !== '') {
          this.set(0);

          this.tile_editor.win.cerrar();
          this.tile_editor = '';
          this.estado=-1;
        }

      },          //{image_url:'' }
      iniset(f_data = {}) //llamado escenario->set
      {
        if (this.tile_editor !== '') 
        {
          console.log('editor imagen cambiada')

          this.tile_editor.images=[$LIB.IMAGES[f_data.img_id[0]], $LIB.IMAGES[f_data.img_id[1]]];            
          this.tile_editor.set_modo()
          this.tile_editor.estado_tiledraw=1;
        }
        else {
          console.log('editor creado')
          console.log(f_data.img_id + "<------------")
          this.tile_editor = DEBUG.crear_tile_editor(
            _root,
            {
              ...{
                x: WIN.x + WIN.wr, y: WIN.y,
                odiv_des: WIN._bloque,
                cursor_des: WIN.cursor_bloque,

                tileges: $tileges,                
                
                on_get_map: game.mapcon.on_get_map,
                teclado: WIN.teclado,

                mapcon:
                {
                 on_load(_map)
                 {
                  game.mapcon.set(_map,0);
                 },

                },

        
                menu:{ //se incorporan a funciones por defecto
                 Map:
                  {
                    'Propiedades mapa'()
                    {


                    let _map = game.mapcon.map;

                      let _sub = game.editor.tile_editor.win.crear_subventana({x:0, y:0, w:300,h:300, grab:1, titulo: 'Propiedades mapa',

                        });


            _sub.mostrar_error=(f_texto='ERROR')=>
            {

             let _err  = _sub.crear_subventana({x:35,y:50,w:200,h:150,titulo:'Error', grab:1,});
                   
                    let _tmes = _FORM.crear_text(_err._bloque, {texto: f_texto,  
                              x:0,y:10,w:[5,5], h:60, style:{border:'none', whiteSpace:'wrap'} });

                    _FORM.crear_boton(_err._bloque, {x:40, y:70, w:100,texto:'Ok', mousedown:()=>                      
                      {
                       _err.cerrar();
                      }

                     });

            }

                      console.log(_map)


                      _FORM.crear_text(_sub._bloque, {texto: 'Nombre:',  
                              x:10,y:10,w:90, h:30, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_nombre = _FORM.crear_input(_sub._bloque,{x:0,y:10,w:[100,10],h:20,max_char:19, value:_map.nombre });


                      _FORM.crear_text(_sub._bloque, {texto: 'Ini submap:',  
                              x:10,y:50,w:90, h:30, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_ini_submap = _FORM.crear_input(_sub._bloque,{x:0,y:50,w:[100,10],h:20,max_char:2, value:_map.ini_submap });


              _FORM.crear_boton(_sub._bloque, {x:10, y:220, w:100,texto:'Aplicar', mousedown:()=>                      
                      {
                       
               
                  let _v_nombre     = remove_lastspace_string(_i_nombre.get_value() ); 
                  let _v_ini_submap = _i_ini_submap.get_value();
                  

                  if(_v_nombre == '' )
                  {
                        _sub.mostrar_error('Nombre no valido');              
                        return;
                  }
            

                       if(!is_numeric(_v_ini_submap ) )
                       {
                        _sub.mostrar_error('Ini_submap no valido');

                        return;
                       }
                       
                       

                      _map.nombre     = _v_nombre; 
                      _map.ini_submap = string_to_number(_v_ini_submap) ;
                      

                       _sub.cerrar();
                      


                      }});

              _FORM.crear_boton(_sub._bloque, {x:130, y:220, w:100,texto:'Cancelar', mousedown:()=>                      
                      {
                       _sub.cerrar();
                      }});





                    }, //propiedades mapa
                    'Nuevo mapa'(){
                       let _tileges = this.tileges;
                       _tileges.remade_tilemaps(_tileges.yt_max,_tileges.xt_max,0);

                        game.remove_all_obj();
                        $root.level.jugador.x=0;
                        $root.level.jugador.y=0;
                     
                    },
                   'Limpar mapa'(){
                    let _tilemaps_all =this.tileges.tilemaps_all;

                      for(var k of _tilemaps_all)
                      {
                        for(var i in k)
                        {
                          for(var j in k[i])
                          {
                              k[i][j]=0;
                          }
                        }
                      }
                     this.tileges.refresh.force();
                      game.remove_all_obj();
                      


                   },
                   

                  },//map
                  Submaps:
                  {
                   
                   
                   'Propiedades submap'()
                   {

                    let _submap = game.mapcon.submap;

                      let _sub = game.editor.tile_editor.win.crear_subventana({x:0, y:0, w:300,h:300, grab:1, titulo: 'Propiedades submapa',

                        });


            _sub.mostrar_error=(f_texto='ERROR')=>
            {

             let _err  = _sub.crear_subventana({x:35,y:50,w:200,h:150,titulo:'Error', grab:1,});
                   
                    let _tmes = _FORM.crear_text(_err._bloque, {texto: f_texto,  
                              x:0,y:10,w:[5,5], h:60, style:{border:'none', whiteSpace:'wrap'} });

                    _FORM.crear_boton(_err._bloque, {x:40, y:70, w:100,texto:'Ok', mousedown:()=>                      
                      {
                       _err.cerrar();
                      }

                     });

            }


                      console.log(_submap)


                      _FORM.crear_text(_sub._bloque, {texto: 'Nombre:',  
                              x:10,y:10,w:200, h:60, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_nombre = _FORM.crear_input(_sub._bloque,{x:0,y:10,w:[100,10],h:20,max_char:19, value:_submap.nombre });


                      //tema
                      let _c = _FORM.crear_categoria(_sub._bloque, {texto:'Tema', x:0,y:0, w:[10,10], h:[50,150]});

                      _FORM.crear_text(_c.odiv, {texto: 'Id:',  
                              x:10,y:15,w:40, h:60, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_tema_id = _FORM.crear_input(_c.odiv,{x:50,y:15, w:50,h:20,max_char:2, value: _submap.tema.id });


                      _FORM.crear_text(_c.odiv, {texto: 'Vol:',  
                              x:120,y:15,w:40, h:60, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_tema_vol = _FORM.crear_input(_c.odiv,{x:150,y:15, w:50,h:20,max_char:3, value:_submap.tema.vol });


                    //fondo
                      let _c2 = _FORM.crear_categoria(_sub._bloque, {texto:'Fondo', x:0,y:120, w:[10,10], h:50});

                      _FORM.crear_text(_c2.odiv, {texto: 'Id:',  
                              x:10,y:15,w:40, h:60, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      let _i_fondo_id = _FORM.crear_input(_c2.odiv,{x:50,y:15, w:150,h:20,max_char:15,  value:_submap.fondo.id });

                      /*_FORM.crear_text(_c2.odiv, {texto: 'Vol:',  
                              x:120,y:15,w:40, h:60, style:{textAlign:'left', border:'none', whiteSpace:'wrap'} });

                      _FORM.crear_input(_c2.odiv,{x:150,y:15, w:50,h:20,max_char:19 });
                      */


              _FORM.crear_boton(_sub._bloque, {x:10, y:220, w:100,texto:'Aplicar', mousedown:()=>                      
                      {
                       
               
                  let _v_nombre   = remove_lastspace_string(_i_nombre.get_value() ); 
                  let _v_tema_id  = _i_tema_id.get_value();
                  let _v_tema_vol = _i_tema_vol.get_value();

                  let _v_fondo_id = remove_lastspace_string(_i_fondo_id.get_value() );

                  if(_v_nombre == '' )
                  {
                        _sub.mostrar_error('Nombre no valido');              

                        return;
            
                  }
                  if(_v_fondo_id == '' )
                  {
                        _sub.mostrar_error('Fondo id no valido');              
                        return;
            
                  }


                       if(!is_numeric(_v_tema_id ) )
                       {
                        _sub.mostrar_error('Tema id no valida');              

                        return;
                       }
                       if(!is_numeric(_v_tema_vol ) )
                       {
                       
                        _sub.mostrar_error('Tema vol no valida');              

                         return;
                       }
                       

                      _submap.nombre = _v_nombre; 
                      _submap.tema.id=string_to_number(_v_tema_id) ;
                      _submap.tema.vol=string_to_number(_v_tema_vol);
                      _submap.fondo.id = _v_fondo_id;




                       _sub.cerrar();
                      


                      }});

              _FORM.crear_boton(_sub._bloque, {x:130, y:220, w:100,texto:'Cancelar', mousedown:()=>                      
                      {
                       _sub.cerrar();
                      }});



                   },

                   'Add submap'()
                   {
                   let _xt_max = GES.tileges.xt_max;
                   let _yt_max = GES.tileges.yt_max;
                   
                   
                   if(game.escenario.act.name=='play_0')
                       _yt_max --;

                   let _submap =
                     {
                      nombre:'Nuevo_submap',
                      descripcion:'',
                      id:game.mapcon.map.submaps.length,
                      tema:{
                      id:5,
                      vol:0.5,
                      }, 
                      fondo:
                      {
                      id:"campo_a",
                      },
                      
                      tilemaps:[
                       crear_multiarray(_yt_max, _xt_max, 0),
                       crear_multiarray(_yt_max, _xt_max, 0),
                       crear_multiarray(_yt_max, _xt_max, 0),
                       crear_multiarray(_yt_max, _xt_max, 0)
                      ],

                     }
                   
                   game.mapcon.map.submaps.push(_submap);
                   game.mapcon.map_master.submaps.push(clone_object(_submap) ); //es necesario clonar?
                   game.mapcon.update_menu_submaps();





                   },


                   'Log submaps'()
                   {
                    console.log(game.mapcon.map.submaps)

                   },

                   'Submaps->':
                   {
                      

                   }
                 }//submaps
                },

                objcon:{
                        callback: bindear_(game.cargar_enemigo, game)
                       },


                images: [$LIB.IMAGES[f_data.img_id[0]], $LIB.IMAGES[f_data.img_id[1]]], 
                
                offset_obj: { x: 0, y: 0 },

                tw: 4,
                th: 4,
                minimap_scale: 4,
                key:
                {
                  erase: ['lshift', 0], //tecla, indice tile vacio
                  drop: 'ctrl',
                },
                on_set_title(f_text) {
                  return (f_text + '[' + game.editor.estado + ']');
                },
                on_save_objtile(f_obj) {

                  if (f_obj !== 0 && f_obj !== undefined) {
                    let _end = clone_object(f_obj);
                    _end.in = 0;
                    delete _end._clip; //eliminar referencia clip
                    return (_end);
                  }
                  return (f_obj);

                }

              },
              ...f_data
            })//creacion editor
        }
        this.set(0);

        WIN.obj.focus();


      },

    },//editor
    on_keydown(_key) {
        this.editor.on_keydown(_key);
        this.escenario.on_keydown(_key);
        this.pausecon.on_keydown(_key);
    },
    on_mousedown(e) {
        this.editor.on_mousedown(e);
    },
    on_mouseup(e) {
        this.editor.on_mouseup(e);
    },
    on_mousemove(e) {
        this.editor.on_mousemove(e);
    },


    center_compare(_a, _b) {
      let _end = { x: '', y: '' };

      if (_a.x + _a.w / 2 < _b.x + _b.w / 2)
        _end.x = 0;
      else
        _end.x = 1;

      if (_a.y + _a.h / 2 < _b.y + _b.h / 2)
        _end.y = 0;
      else
        _end.y = 1;

      return (_end);

    },
    simple_hit_test(_a, _b) {

      if (_a.x + _a.w > _b.x && _a.x < _b.x + _b.w &&
        _a.y + _a.h > _b.y && _a.y < _b.y + _b.h) {
        return (1);
      }

    },
    find_in_obj_layer(_a, _b)
    {
        let _tilemap = $tileges.tilemaps_all[3];
       for(var i in _tilemap)
          {
             for(var j in _tilemap[i])
             {
               let u = _tilemap[i][j];

               if(u[_a]==_b)
               {
                return(u);
               }

             }

          }

    },


  center_nivel(f_x, f_y, _limit=1)
  {

   let _yp = 0;
   let _xp = 0;
    if(get_type(f_x)=='object') //centrar a objeto
    {
      let   _u = f_x;
      f_x = _u.x+_u.w/2;
      f_y = _u.y+_u.h/2;
      if(_u.limit!==undefined)
        _limit = _u.limit;

      if(_u.xp!==undefined) _xp = _u.xp;
      if(_u.yp!==undefined) _yp = _u.yp;

    }

    
    //$root.level.x = fl((f_x * -1)  + $root.w / 2);
    //$root.level.y = fl((f_y * -1)  + $root.h / 2);
    $root.level.x = ((f_x * -1)  + game.wcanvas / 2);
    $root.level.y = ((f_y * -1)  + game.hcanvas / 2);

    if(_limit)
    {

    if ($root.level.x > 0) 
      $root.level.x = 0;
    
    if ((-$root.level.x) + $gameges.tileges.xt_max * 16 > $gameges.tileges.xt_allmax * 16) 
      $root.level.x = -($gameges.tileges.xt_allmax * 16 - $gameges.tileges.xt_max * 16);
    
    if ($root.level.y > 0) 
      $root.level.y = 0;
   

   let _yp = 0;
      if(game.escenario.act.name=='play_0') //considerar hud
        _yp=1;

    if ((-$root.level.y) + ($gameges.tileges.yt_max-_yp) * 16 > $gameges.tileges.yt_allmax * 16) 
      $root.level.y = -($gameges.tileges.yt_allmax * 16 - ($gameges.tileges.yt_max-_yp) * 16);
    }

    $root.level.x +=  _xp;
    $root.level.y +=  _yp;


    $gameges.tileges.x = $root.level.x * -1;
    $gameges.tileges.y = $root.level.y * -1;

  },


    

    remove_all_obj() {
      for(var i = this.objs.length-1; i>=0;i--)
        this.objs[i].remove();

      this.objs = [];


    },
    remove_obj(obj) {
      for (var i = 0; i < this.objs.length; i++) {
        let u = this.objs[i];
        if (u == obj) {
          this.objs.splice(i, 1);
          break;
        }

      }
    },
    cargar_enemigo(f_data) {
      let _x = f_data.x;
      let _y = f_data.y;

      console.log("!!!!!!!")
      console.log(f_data)
      let _clip = WIN.gameges.cargar_clase($root.level, 5,
        {
          
          ...f_data.mapdata,
          ...{
             y: _y * 16,
             x: _x * 16,
             id: f_data.mapdata.id,
             //draw_color:'blue'
             },
        }
      );
      _clip.noclone = 1;

      $tileges.tilemaps_all[3][_y][_x]._clip = _clip;

      _clip.mapdata = f_data.mapdata;
      this.objs.push(_clip);
      _clip.mapdata.in = 1;

      if(this.editor.first_draw==0)//workaround problema level x inadecuado borra enemigos
      enterload(_clip);


    },

    crear_hudbarra(f_donde, f_data={})
    {
       let _data = {
                    ...{
                       x:0,
                       y:0,
                       w:100, //max
                       h:10,
                       texto:{x:0,y:0,texto:''}, //reemplzadado con clip_text posteriormente
                       
                       colores:['white','red'], // fondo, frontal
                       valores:[50,200],
                       clips:[],
                       remove()
                       {
                        for(var u of this.clips)
                        {
                          u.remove();
                        }
                       },
                       
                       set(f_n, _modo)
                       {
                          if(_modo=='set')
                          this.valores[0]=f_n;
                          if(_modo=='+')
                          this.valores[0]+=f_n;
                          if(_modo=='-')
                          this.valores[0]-=f_n;

                        if(this.valores[0]<0)
                          this.valores[0]=0;
                        if(this.valores[0]>this.valores[1])
                          this.valores[0]=this.valores[1];

                        let _w = this.valores[0]/this.valores[1]; //0->1
                          
                    
                         this.clips[1].w = fl(this.w*_w);

                       },
                       },
                    ...f_data
                   }

   _data.clips =
   [
   WIN.gameges.crear_vacio(f_donde, 2,
                {
                  w: _data.w,
                  h: _data.h,
                  y: _data.y,
                  x: _data.x+(_data.texto.texto.length*4)+2,
                  draw_color: _data.colores[0],
                }),
   WIN.gameges.crear_vacio(f_donde, 2,
                {
                  w: _data.w,
                  h: _data.h,
                  y: _data.y,
                  x: _data.x+(_data.texto.texto.length*4)+2,
                  draw_color: _data.colores[1],
                })
    ];

    _data.texto = game.textoges.crear(f_donde, {x:_data.x+_data.texto.x, y:_data.y+_data.texto.y, texto:_data.texto.texto},"tb4x4")

    _data.clips.push(_data.texto);

    
    _data.set();            



    return (_data);


    }

  }//game



padrear(game);



  var WIN = ventana.crear_ventana(_root,
    //400   400
    {
      x: 0, y: 0, w: 32*14, h: 32*12, teclado: 1, titulo: "", grab: 1, resize: flipbin(IS_MOBILE) ,literal:1,
      menu: {
        Juego: {
          'Reiniciar->':
          {

          'Hard mapa'() 
          {
            

          },
          'Soft submapa'() {
            game.mapcon.reset(0, game.mapcon.sub);

          },


          }
          
        },
        Opciones: { 
          'Tamao de la pantalla':
          {
            'X1'()
            {
             WIN.set_literal_size(game.wcanvas, game.hcanvas);

            },
            'X2'()
            {
             WIN.set_literal_size(game.wcanvas*2, game.hcanvas*2);
            },
            'X3'()
            {
             WIN.set_literal_size(game.wcanvas*3, game.hcanvas*3);
            }

          },

          Controles: 'Proximamente' 

        },
        Escenas: {
          'intro_0'() { game.escenario.set('intro_0') },
          'intro_1'() { game.escenario.set('intro_1') },
          'menu_0'() { game.escenario.set('menu_0') },
          'wmap'() { game.escenario.set('wmap') },
          'play_0'() { game.escenario.set('play_0') },

        },
        $Ayuda: {
          'Acerca de...'() {
            alert('23/09/2023')




          }
        }

      }
    },
    {
      borde: [5, 5, 5, 5],
    })


  WIN._bloque.obj.style.background = "black";



  if (IS_MOBILE) {
    WIN.set_h(WIN.hr + 95);
    TECLADO.crear_teclado_visual(WIN, WIN.teclado, 'basico', {
       botones:{
         z:{x:10, w:70,h:70, y:20},
         x:{x:79, w:70,h:70, y:20},

         der:{x:50*0+10},
         aba:{x:50*1+10-1},
         arr:{x:50*1+10-1},
         izq:{x:50*2+10-2},

       },

       base:{style:{background:'white',border:'none'}  }});


  }




//|imp
  //imp images
  WIN.load_isc([
    "_data/images/fondo_0.png",
    "_data/images/image_03.png",
    "_data/images/lau_spritesheet.png",
    "_data/images/efecto16.png",
    "_data/images/tileset16_0.png",
    "_data/images/lau_tileset16_0.png",//5
    "_data/images/shoot.png",
    "_data/images/enemigos_sprites.png",
    "_data/images/armas_sprites.png",
    "_data/images/fondo_A0.png",

    "_data/images/fondo_A1.png", //10
    "_data/images/fondo_A2.png",
    "_data/images/misc.png",
    "_data/images/lau_tileset16_wm.png",
    "_data/images/watons_sprites_wm.png",
    "_data/images/cinema.png",//15
    "_data/images/fuente_nb8x8.png",
    "_data/images/tileobj_1.png",
     "_data/images/tileobj_0.png",
     "_data/images/fuente_tn10x18.png",
    
     "_data/images/fuente_tn5x9.png",//20
     "_data/images/fuente_tn10x18_b.png", //press start menu
     "_data/images/npc.png",
     "_data/images/fuente_tn8x8.png",
     "_data/images/fuente_tr8x8.png",
     "_data/images/fuente_ta8x8.png",//25
     "_data/images/fondo_campo_b_0.png",
     "_data/images/fondo_campo_b_1.png",
     "_data/images/fuente_tb4x4.png",
     "_data/images/items.png",

     "_data/images/fuente_tnb10x18.png", //cerveza y libertad
     "_data/images/fuente_tng10x18.png", //cerveza y libertad

  ],

    //|imp sounds
    [
    
    "_data/sounds/hit_0.wav",
    "_data/sounds/hit_1.wav",
    "_data/sounds/jump_0.wav",
    "_data/sounds/jump_1.wav",
    "_data/sounds/jump_2.wav",

    "_data/sounds/tema_0.wav",//5
    "_data/sounds/tema.wav",
    "_data/sounds/lifelost.mp3",
    "_data/sounds/ataque_sw_0.mp3",
    "_data/sounds/hit_2.mp3", //caida fuera de mapa

    "_data/sounds/intro_tema.mp3", //10
    "_data/sounds/menu_select_0.mp3", 
    "_data/sounds/menu_select_1.mp3", 
    "_data/sounds/puerta.mp3", 
    "_data/sounds/tema_1.mp3",
    "_data/sounds/swoogg.wav",//15
    "_data/sounds/brick.wav",
    "_data/sounds/pick0.wav",
    "_data/sounds/grab_2.wav",
    "_data/sounds/toc_0.mp3",
    "_data/sounds/toc_1.mp3",//20
    "_data/sounds/toc_2.mp3",
    
     ],

   //|imp class

    ["_data/class/player.js",
      "_data/class/obj_e16.js",
      "_data/class/obj_testvacio.js",
      "_data/class/obj_test_entesprite.js",
      "_data/class/shoot.js",
      "_data/class/enemigos.js",//5

      "_data/class/config.json",
      //"_data/maps/scrolltest.json",
      //"_data/maps/ruinas_del_bosque.json",
      "_data/maps/0_bar.json",
      //"_data/maps/pradera_simplona.json",
      "_data/class/player_wm.js",
      "_data/maps/wm00.json",
      "_data/class/tiledata_wm.json",//10

      "_data/maps/menu0.json",

    ],


    game.ini);



</script>